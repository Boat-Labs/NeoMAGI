# NeoMAGI 项目分阶段规划 v2

> 基于 v1 (`design_docs/roadmap_milestones.md`) 演进。
> 变更原因：M1.2 审计延期项需要明确里程碑落点（ADR 0018）。
> 变更内容：新增 M1.4（审计修复收尾），调整推荐实现顺序。

## 1. 规划原则
- 目标清晰，阶段精简，优先做可验证的用户价值闭环。
- 以个人使用场景为主，避免提前引入重运营负担。
- 每个阶段必须有明确"进入条件 + 验收标准 + 退出条件"。

## 渠道基线定义
- 第一渠道：WebChat（主入口）。
- 第二渠道：Telegram（扩展入口）。

## 2. 能力包（Package）划分

| Package | 定位 | 产出关注点 |
| --- | --- | --- |
| P0 治理与决策追踪 | 控制方向与范围 | 决策可追溯、范围不漂移 |
| P1 核心代理闭环 | 核心价值成立 | 用户可稳定完成主任务 |
| P2 会话内连续性 | context window 内连续体验 | transcript、压缩后连续性、角色一致性 |
| P3 会话外持久记忆 | context window 外长期连续性 | 日记沉淀、长期记忆、召回有效 |
| P4 第二渠道适配 | 从单入口到双入口 | 第二渠道可用且体验一致 |
| P6 模型迁移验证 | 控制模型依赖风险 | OpenAI 默认，Gemini 迁移可验证 |
| P5 运营可靠性（后置） | 按需提升运行质量 | 最小可观测、恢复、数据安全基线 |

## 3. 里程碑（Milestone）与验收标准

### M0：治理最小化落地（对应 P0）
**目标**
- 用最小机制完成决策追踪与范围控制。

**建议产物**
- `decisions/` 目录（ADR-lite）。
- `decisions/INDEX.md` 用于决策索引与状态追踪。

**验收标准**
- 关键决策都有记录（背景、决策、影响、状态、日期）。
- 需求范围或优先级变化时，能在 `decisions/` 中追溯原因。
- 当前路线图与决策记录一致，无明显冲突。

---

### M1.1：基础交互闭环（对应 P1）
**目标**
- 用户提出需求后，系统能在主入口给出可用结果。

**验收标准**
- 主流程可稳定完成，不依赖人工补偿。
- 用户对结果"可继续下一步"的判断比例稳定。

### M1.2：任务完成闭环（对应 P1）
**目标**
- 支持连续任务推进，避免"一问一答式"中断。

**验收标准**
- 典型多步任务可从开始走到完成。
- 中途状态可感知，用户知道下一步该做什么。

### M1.3：稳定性闭环（对应 P1）
**目标**
- 在失败或不确定场景下，仍保持可恢复体验。

**验收标准**
- 失败场景有清晰恢复路径。
- 核心任务在重复执行时表现稳定、结果一致性可接受。

### M1.4：审计修复收尾 + 测试基础设施（对应 P1）[v2 新增, v3 扩展]
**目标**
- 修复 M1.2/M1.3 审计延期项，恢复流式输出体验，补齐集成测试与 CI 基础设施。

**来源**
- M1.2 审计计划 (`dev_docs/plans/m1.2_audit-fixes_2026-02-18.md`) 中延期的 F4 + F6b。
- M1.3 评审修复 (`dev_docs/plans/m1.3_review-fixes_2026-02-18.md`) 中延期的测试基础设施与可靠性增强。

**范围**
| 编号 | 内容 | owner | due |
|------|------|-------|-----|
| F4 | token 级流式输出恢复：agent loop 流式聚合 tool_calls delta，final answer 逐 token 流式 | backend | 2026-03-04 |
| F6b | 集成测试补齐：tool loop 前端状态流转测试 + WebSocket 集成测试 | backend | 2026-03-04 |
| T1 | PG 集成测试基础设施：conftest.py 容器化 PG fixture + 至少 3 条真实 DB 集成测试（claim/release、seq 原子分配、force reload） | backend | 2026-03-04 |
| T2 | CI 落地：GitHub Actions workflow + PostgreSQL service container，执行 migration + 全量测试 | backend | 2026-03-04 |
| T3 | 前端 vitest 基础设施：守卫恢复测试自动化（替代当前手动验收） | frontend | 2026-03-04 |
| R1 | history 请求超时兜底：防止 pending 状态无限挂起 | backend | 2026-03-04 |
| R2 | 锁 fencing 或 heartbeat 续租：`_persist_message` 加 token 校验或后台续租，增强串行化语义 | backend | 2026-03-04 |

**可选延后项（M1.4+，按需纳入）**
| 内容 | 说明 |
|------|------|
| 稳定 message_id 贯穿前后端 | 增量同步基础，需 client_message_id + server_message_id |
| SESSION_BUSY 前端自动重试 | 当前仅 toast 提示，用户手动重发 |

**验收标准**
- final answer 恢复逐 token 流式输出，首字延迟回到 M1.1 水平。
- tool loop + 前端状态流转有端到端测试覆盖。
- PG 集成测试覆盖 claim/release、seq 原子分配、force reload 三条核心路径。
- CI workflow green：migration + pytest + ruff 在 GitHub Actions 上通过。
- 前端守卫恢复测试在 vitest 中自动化执行。
- 全量测试通过，ruff clean。

---

### M2：会话内连续性（对应 P2，明确边界）
**边界定义**
- 仅覆盖 context window 内的连续性问题。

**目标**
- 保证会话内容在窗口内与压缩后保持连续语义与稳定角色。

**验收标准**
- transcript 管理后对话连续性稳定。
- compaction 后关键上下文不明显丢失。
- 角色与用户偏好在会话内保持一致。

---

### M3：会话外持久记忆（对应 P3，明确边界）
**边界定义**
- 仅覆盖 context window 外的持久化记忆问题。

**目标**
- 建立"可沉淀、可检索、可治理"的长期记忆闭环。

**验收标准**
- 用户明确要求保留的信息可被可靠沉淀。
- `daily notes` 与 `MEMORY.md` 的分层角色清晰且执行稳定。
- 检索结果可支持后续任务，减少重复沟通。

---

### M4：第二渠道适配（对应 P4）
**目标**
- 在 WebChat 主入口之外，新增 Telegram 作为可稳定工作的第二渠道。

**验收标准**
- Telegram 可独立完成核心任务流程。
- 第二渠道与主入口在行为策略上保持一致。

---

### M6：模型迁移验证（对应 P6，精简版）
**目标**
- 以 OpenAI 为默认运行模型，同时验证 Gemini 的可迁移性。

**验收标准**
- 同一组代表性任务可在 OpenAI 和 Gemini 上完成。
- 模型切换策略明确，出现异常有清晰回退路径。
- 团队可据此判断后续模型路线，而非依赖主观感受。

---

### M5：运营可靠性（后置，可按需触发，对应 P5）
**目标**
- 在个人使用规模下，仅补齐最小运营与可靠性基线。

**触发条件（任一满足即可进入）**
- 出现明显稳定性问题并影响日常使用。
- 数据安全或恢复风险升高。
- 使用频率提升，现有运行方式难以维护。

**验收标准（M5-lite）**
- 关键状态可观测。
- 异常后可恢复。
- 重要数据有基本保护与恢复手段。

## 4. 推荐实现顺序
1. M0
2. M1.1
3. M1.2
4. M1.3
5. **M1.4** [v2 新增]
6. M2
7. M3
8. M4
9. M6
10. M5（仅在触发条件出现时进入）

## 5. 阶段切换规则
- 未达到当前阶段验收标准，不进入下一阶段。
- 如发生范围膨胀，优先收敛到当前阶段目标。
- 每个阶段结束做一次"保留/推迟/放弃"决策，持续控制复杂度。

## 6. 版本变更记录
| 版本 | 日期 | 变更 | 决策依据 |
|------|------|------|----------|
| v1 | 2026-02-16 | 初始版本 | — |
| v2 | 2026-02-18 | 新增 M1.4（审计修复收尾：F4 流式恢复 + F6b 集成测试） | ADR 0018, `dev_docs/plans/m1.2_audit-fixes_2026-02-18.md` |
| v3 | 2026-02-18 | 扩展 M1.4 范围：纳入 M1.3 延期项（PG 集成测试、CI、vitest、history 超时、锁 fencing） | M1.3 review findings, `dev_docs/plans/m1.3_review-fixes_2026-02-18.md` |
