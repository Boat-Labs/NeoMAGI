# NeoMAGI 产品路线图 v3（Product-Oriented）

> 基于 v2 (`design_docs/roadmap_milestones_v2.md`) 演进。  
> 日期：2026-02-23

## 1. 这份 roadmap 管什么，不管什么

### 管什么（产品层）
- 目标用户价值（用户为什么需要这个阶段）。
- 阶段边界（做什么 / 不做什么）。
- 验收标准（是否“对用户可用”）。
- 里程碑优先级和推荐顺序。

### 不管什么（实现层）
- 不写任务拆分、owner、工期、代码级实现步骤。
- 不做 micro management。
- 技术方案细节写入 architecture 文档与 `decisions/`。

---

## 2. 当前进展快照（截至 2026-02-23）

- `M0`：已完成（治理与决策追踪）。
- `M1.1 ~ M1.4`：已完成（基础交互、任务闭环、稳定性、测试与 CI 基线）。
- `M1.5`：已完成（Tool Modes 可控执行闭环）。
- 当前阶段判断：`M2` 已完成，进入 `M3`（会话外持久记忆）实现阶段。
- M3 启动门槛新增：先落地最小运行时反漂移防护（ADR 0035），再推进后续 memory phases。

---

## 2.1 长期目标校准（伙伴式 AI）

长期目标保持不变：构建“可长期协作、代表用户信息利益”的伙伴式 AI 助手。  
该目标在 roadmap 层固化以下不可退让约束：

- 用户利益优先：任何自我进化不得偏离“代表用户信息利益”。
- 自我进化必须可验证、可回滚：没有 eval 与 rollback，不算有效进化。
- 能力扩展遵循原子工具路线：先小能力、可组合、可审计，再扩展触达范围。
- `SOUL.md` 护栏：原则上仅允许 AI 写入；人类不直接编辑内容，但保留 veto/rollback 权限。
- 会话隔离与记忆召回必须同源治理：session scope 与 memory scope 使用同一策略，不允许“会话隔离正确但记忆跨作用域泄漏”。

该校准不改变当前推荐顺序（`M1.5 -> M2 -> M3 -> M6 -> M4 -> M5`），仅补充阶段验收口径。

### 2.2 会话隔离校准（dmScope）
- 对齐 OpenClaw `dmScope` 策略作为后续演进起点：`main`、`per-peer`、`per-channel-peer`、`per-account-channel-peer`。
- 阶段分工：
  - M3：定义并验收作用域契约（会话解析、记忆写入元数据、检索/注入过滤口径）。
  - M4：在第二渠道（Telegram）接入时激活非 `main` 作用域并完成渠道映射。
- 当前 WebChat 单用户路径可继续使用 `main` 作为默认运行形态，但不再作为长期唯一策略。

---

## 3. 里程碑（产品视角）

### M1.5：可控执行闭环（Tool Modes）
**用户价值**
- 用户在默认安全模式下与 agent 协作时，工具行为边界清晰、可预期，为后续开放更强执行能力打基础。

**边界**
- In:
  - 工具按模式授权（区分 `chat_safe` 与 `coding`，但本阶段仅启用 `chat_safe`）。
  - 模式切换归用户会话级显式控制，不做自动意图切换。
  - 高风险操作有明确拒绝或确认机制。
- Out:
  - 不在本阶段开放 `coding` 模式与“读-写-改-执行”完整闭环。
  - 不追求复杂权限系统（如多角色 RBAC、组织级策略中心）。
  - 不在本阶段引入过多外部系统权限集成。
  - 不在本阶段交付会话外记忆写入闭环（`memory_append` 实现归 M3）。

**验收标准（Use Case）**
- 用例 A：默认 `chat_safe` 会话中，读取/检索类请求可稳定执行，写入/执行类请求会被明确拒绝并说明原因。
- 用例 B：mode 仅能由用户显式设置为会话配置，agent 不会因意图判断自动切换。
- 用例 C：高风险命令不会静默执行，用户能感知并控制风险。

---

### M2：会话内连续性
**用户价值**
- 长对话、多轮任务过程中，agent 不会“失忆”或角色漂移。

**边界**
- In:
  - 会话内上下文治理（包括接近窗口上限时的连续性保障）。
  - 会话内角色与偏好稳定保持。
- Out:
  - 不解决跨天/跨会话记忆（那是 M3）。

**验收标准（Use Case）**
- 用例 A：用户连续进行 30+ 轮任务后，关键约束仍被正确遵守。
- 用例 B：会话压缩后继续提问，关键上下文可延续，任务不中断。
- 用例 C：在长轮次与压缩后场景中，用户利益约束和角色边界不漂移（反漂移基线）。

---

### M3：会话外持久记忆
**用户价值**
- 隔天继续对话时，agent 能记住用户偏好、长期目标和已确认事实。

**边界**
- In:
  - 运行时最小反漂移防护（M3 前置）：关键约束可见性 guard + 高风险路径 fail-closed 执行闸门。
  - 短期记忆沉淀与长期记忆策展形成闭环。
  - 记忆可检索、可复用、可治理（可纠错/可更新）。
  - 作用域治理闭环：会话解析、记忆写入、记忆检索、prompt recall 在同一 `dmScope` 语义下工作。
  - 自我进化最小闭环：提案、评测、生效、回滚与审计记录。
  - `SOUL.md` 更新遵循 AI-only 写入 + 用户 veto/rollback 的治理边界。
- Out:
  - 不追求“全知全记”，不做重型知识图谱工程。
  - 不在本阶段完成第二渠道的全量 `dmScope` 激活与联调（渠道落地归 M4）。
  - 不允许未评测、不可回滚的人格/行为变更直接生效。

**验收标准（Use Case）**
- 用例 A：用户前一天明确的偏好，第二天无需重复输入即可生效。
- 用例 B：用户追问历史决策原因，agent 能基于记忆给出可追溯回答。
- 用例 C：agent 提出 `SOUL.md` 更新后，只有通过评测的变更才会生效；失败可自动回滚。
- 用例 D：用户可对已生效变更执行 veto/rollback，系统恢复到上一个稳定版本并保留审计记录。
- 用例 E：不同会话作用域下，记忆召回遵循 `dmScope`，不会出现未授权跨作用域泄漏。
- 用例 F：长对话压缩后若 guard 失败，高风险工具调用被阻断（fail-closed）；纯对话路径可降级继续且有审计日志。

---

### M6：模型迁移验证
**用户价值**
- 用户不被单一模型供应商绑定，关键任务可迁移且可回退。

**边界**
- In:
  - OpenAI 为默认路径，Gemini 做等价任务验证。
  - 定义切换与回退策略。
- Out:
  - 不在本阶段扩展到过多 provider。

**验收标准（Use Case）**
- 用例 A：同一批代表性任务在 OpenAI 与 Gemini 均可完成。
- 用例 B：切换后若质量或稳定性下降，可快速回退到默认路径。

---

### M4：第二渠道适配（Telegram）
**用户价值**
- 用户可在 WebChat 之外，通过第二入口稳定使用同一 agent 能力。

**边界**
- In:
  - Telegram 打通核心任务流程。
  - 关键行为策略与 WebChat 保持一致。
  - 激活并验证非 `main` 的 `dmScope` 策略（如 `per-peer` / `per-channel-peer`），完成渠道身份映射。
- Out:
  - 不做多渠道复杂运营功能（群控、营销、自动化运营等）。

**验收标准（Use Case）**
- 用例 A：用户在 Telegram 发起核心任务，完成体验与 WebChat 一致。
- 用例 B：渠道切换不改变核心能力边界和安全策略。
- 用例 C：跨渠道会话隔离行为与 `dmScope` 配置一致，且记忆召回范围与会话隔离保持一致。

---

### M5：运营可靠性（后置触发）
**用户价值**
- 当使用频率上升时，系统仍可观测、可恢复、可维护。

**触发条件（任一满足即可进入）**
- 稳定性问题开始影响日常使用。
- 数据安全/恢复风险上升。
- 维护成本明显上升。

**边界**
- In:
  - 最小观测、备份与恢复能力。
- Out:
  - 不提前建设企业级运维平台。

**验收标准（Use Case）**
- 用例 A：出现异常后，用户或维护者可以在可接受时间内恢复服务。
- 用例 B：关键数据具备基本保护和恢复路径。

---

## 4. 推荐顺序（v3）
1. M1.5（可控执行闭环）
2. M2（会话内连续性）
3. M3（会话外持久记忆）
4. M6（模型迁移验证）
5. M4（第二渠道适配）
6. M5（触发式进入）

排序说明：
- M6 排在 M4 之前，是为了先验证模型迁移与回退策略，再扩展第二渠道，减少渠道适配后的重复校准成本。

---

## 5. 阶段切换规则
- 未达到当前阶段验收标准，不进入下一阶段。
- 新需求优先归类到当前阶段；若越界，先做取舍再纳入。
- 每阶段结束后仅做三类决策：`保留 / 推迟 / 放弃`。

---

## 6. 版本变更记录
| 版本 | 日期 | 变更 | 依据 |
| --- | --- | --- | --- |
| v1 | 2026-02-16 | 初始版本 | — |
| v2 | 2026-02-18 | 新增 M1.4（审计修复收尾 + 测试基建） | ADR 0018 |
| v3 | 2026-02-19 | roadmap 转为产品导向；新增 M1.5（可控执行闭环）；重排后续顺序 | ADR 0023 + ADR 0024 |
| v3.1 | 2026-02-21 | 新增长期目标校准约束；补充 M2 反漂移验收与 M3 自我进化治理验收 | ADR 0027 |
| v3.2 | 2026-02-21 | 同步阶段快照：M1.5 已完成，当前进入 M2 | 状态同步 |
| v3.3 | 2026-02-22 | 对齐 OpenClaw `dmScope`：补充 M3 作用域治理验收与 M4 渠道激活边界 | ADR 0034 |
| v3.4 | 2026-02-23 | 新增 M3 启动门槛：最小运行时反漂移防护（Core contract guard + 风险分级 fail-closed） | ADR 0035 |
