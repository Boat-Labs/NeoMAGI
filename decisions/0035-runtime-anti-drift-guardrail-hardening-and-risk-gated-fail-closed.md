# 0035-runtime-anti-drift-guardrail-hardening-and-risk-gated-fail-closed

- Status: accepted
- Date: 2026-02-23

## 选了什么
- 在 ADR 0030（离线反漂移基线）的基础上，加一层**运行时最后防线**：
  - 如果上下文压缩后关键约束可能丢失，系统不能继续放行高风险动作。
- guard 的判断口径统一为：**最终执行上下文可见性**（system prompt + compacted context + effective history）。
- guard 在两个时点使用：
  - LLM 调用前做一次检查，得到 guard 状态。
  - 工具执行前复用 guard 状态做闸门，尤其是高风险工具。
- 失败语义采用风险分级（不是一刀切）：
  - 低风险路径（纯对话/只读类行为）：允许降级继续，但必须记录审计日志。
  - 高风险路径（写入、执行、外部副作用）：**fail-closed 阻断**，返回结构化错误码。
- 落位策略：该防护在 **M3 Phase 0** 落地，作为 M2 风险回补，不重开 M2 开发范围。

## 为什么
- M2 已经证明“多数场景下锚点可见”，但 guard 失败时仍偏向 fail-open，高风险动作缺少最后拦截。
- 把“约束可见性”从验收证据升级为运行时门槛，可以直接降低长对话压缩导致的越权执行风险。
- 在 M3 Phase 0 实施，能复用同一轮主链路改造（ToolContext/PromptBuilder/AgentLoop），返工最少。
- 风险分级是折中方案：既保留会话连续性，又守住高风险边界。

## 放弃了什么
- 方案 A：保持 ADR 0030 现状，不加运行时闸门。
  - 放弃原因：只能“事后证明”，不能“事前阻断”。
- 方案 B：guard 一失败就全量停机（所有对话和工具都阻断）。
  - 放弃原因：可用性损失过大，不符合连续性目标。
- 方案 C：先做完 M3 再回头补防护。
  - 放弃原因：风险窗口过长，且后置改造成本更高。

## 影响
- 需要维护 Core Safety Contract 的来源和版本（至少覆盖 AGENTS/USER/SOUL 的不可退让约束）。
- 需要在 AgentLoop 建立统一判定链路：`guard 状态 -> 工具执行闸门`。
- 需要定义高风险识别规则（写入/执行/外部副作用），并在实现层保持可测试、可审计。
- 需要补齐测试：
  - guard 缺失或失败时，高风险工具被阻断；
  - guard 失败时，低风险路径可降级继续；
  - `error_code` 与审计日志字段可追溯。
- 需要同步计划与架构文档：明确该项是 M3 Phase 0 前置门槛，而非仅离线评估事项。
