# 0021-multi-worker-session-ordering-and-no-silent-drop

- Status: accepted
- Date: 2026-02-18

## 选了什么
- 系统部署目标明确支持多 worker，不以单 worker 作为正确性前提。
- 对同一 `session_id`，消息持久化必须满足全序语义（跨 worker 仍保持一致顺序）。
- 数据库冲突处理采用 `no silent drop` 原则：不允许“丢消息仅告警”；必须“最终写入成功”或“向调用方显式失败”。
- 语义先行：先固定一致性目标，再按里程碑分阶段实现，不以短期实现简化替代语义约束。

## 为什么
- 实际调用大模型 API 存在高延迟，单 worker 容易形成队列堆积并影响可用性。
- 顺序与持久化一致性属于用户可感知行为，若语义不清会导致历史错乱、重复或丢失，破坏系统可信度。
- 提前固化语义边界可避免后续实现和测试口径漂移，降低返工成本。

## 放弃了什么
- 方案 A：默认单 worker，后续再考虑并发一致性。
  - 放弃原因：与实际吞吐需求不匹配，且会把核心一致性风险后置。
- 方案 B：发生 DB 冲突时“丢消息+告警”即可。
  - 放弃原因：属于静默数据丢失，不符合消息系统的基本可靠性要求。
- 方案 C：先做实现，语义边界暂不定义。
  - 放弃原因：会导致评审、测试与实现标准不一致，难以验收。

## 影响
- 会话持久化实现需提供跨 worker 的同会话顺序保证（例如会话级串行化与原子序号分配）。
- 冲突路径必须有补偿/重试与明确失败返回，不得吞错。
- 测试与验收需覆盖多 worker 并发同 `session_id` 场景，验证顺序稳定与无静默丢失。
- 相关评审文档和关键代码注释可引用本决议（`[Decision 0021]`）统一语义。
