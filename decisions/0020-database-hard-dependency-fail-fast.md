# 0020-database-hard-dependency-fail-fast

- Status: accepted
- Date: 2026-02-18

## 选了什么
- 决议将 PostgreSQL 设为运行时硬依赖：Gateway 启动必须成功连接数据库并完成 schema 准备。
- 当数据库不可用、连接参数错误、schema 不一致时，服务启动直接失败（fail-fast），不再自动降级为内存模式。
- 运行路径保持单一：生产与开发都以“数据库可用”为前提，不维护 memory-only 备用路径。

## 为什么
- 符合当前 MVP 的极简原则：单运行模式比“双模式（DB/内存）”更可预测、更易维护。
- 避免静默降级导致的隐性数据丢失和行为偏差（看起来可用但实际未持久化）。
- 缩短排障路径：配置错误在启动阶段暴露，而不是在运行中出现历史缺失等二次故障。
- 与既有基线决议（PostgreSQL 统一方案）一致，减少架构漂移。

## 放弃了什么
- 方案 A：数据库不可用时自动降级内存模式继续运行。
  - 放弃原因：引入额外分支、状态不一致与不可见风险，不符合“最小概念、最短路径”。
- 方案 B：通过配置开关在 DB / memory-only 之间切换。
  - 放弃原因：增加测试矩阵和运维复杂度，当前阶段收益不足。
- 方案 C：仅告警但继续启动，后续再修复配置。
  - 放弃原因：会把基础设施错误延迟为业务问题，增加恢复成本。

## 影响
- Gateway 启动逻辑需移除 memory fallback，DB 初始化失败时返回明确错误并退出进程。
- 健康检查语义收敛为“服务可用即数据库可用”，不再存在“服务在线但无持久化”状态。
- 本地开发和 CI 必须先满足数据库连接条件；配置模板与文档需明确该前提。
- 若未来需要恢复降级模式，必须新增决议并将本条标记为 superseded。
