# 0022-m1.3-soft-session-serialization-token-ttl

- Status: accepted
- Date: 2026-02-18

## 选了什么
- 在 M1.3 阶段，`session_id` 并发控制采用**软串行化**：数据库 claim 锁使用 `lock_token` + TTL（租约过期时间）实现。
- claim 失败时立即返回 `SESSION_BUSY`，不排队阻塞。
- release 必须 token 匹配（`session_id + lock_token`）才允许释放，防止旧 worker 误释放新锁。
- 本阶段继续严格执行 [Decision 0021] 的 `no silent drop`：持久化失败必须显式返回错误，不得静默丢失。
- fencing（每次持久化校验持锁）与 heartbeat（续租）明确延后到后续里程碑实现。

## 为什么
- 在“最小可用闭环”下，`lock_token + TTL` 能以较低复杂度覆盖主要并发风险。
- token 匹配释放可消除最危险的级联解锁问题（旧请求错误释放新请求锁）。
- TTL 提供崩溃恢复能力，避免僵死锁长期占用会话。
- 相比立即引入 fencing/heartbeat，该方案更符合当前阶段交付节奏与复杂度预算。

## 放弃了什么
- 方案 A：M1.3 直接实现强一致串行化（fencing + heartbeat）。
  - 放弃原因：实现与测试成本显著上升，超出本阶段最小闭环目标。
- 方案 B：仅用 TTL 时间戳，不使用 `lock_token`。
  - 放弃原因：存在旧 worker 误释放新锁的高风险漏洞。
- 方案 C：无 TTL，仅人工解锁。
  - 放弃原因：worker 异常退出后可能长期锁死会话，影响可用性。

## 影响
- 需要在会话锁实现中引入 `lock_token`，并将 release 语义改为“token 匹配释放”。
- TTL 需可配置（建议通过配置项暴露），并在测试中可缩短以验证过期重入场景。
- 本阶段接受已知边界：若请求执行时间超过 TTL 且无续租，可能出现短暂并发处理，表现为上下文质量下降；但不应导致持久化 silent drop。
- 需在计划与验收中明确后续增强项：fencing 与 heartbeat。
