# M1.2 审计修复计划

## Context

基于 M1.2 深审结果（基线 ef96164..aeb8bfb），共 6 项发现。
其中 2 项 P1（工具参数相关）已在后续提交修复，本计划修复 F1 + F5 并补齐对应测试（F6a）。

| 编号 | 级别 | 发现 | 状态 |
|------|------|------|------|
| F1 | P1 | read_file `startswith` 边界绕过 | **待修复** |
| F2 | P1 | 工具参数 null/invalid JSON 崩溃 | 已修复 (472a6a1, 2cf91a1) |
| F3 | P1 | 工具参数非 dict 类型协议断裂 | 已修复 (472a6a1) |
| F4 | P2 | tool loop 丢失 token 级流式 | **延至 M1.4**，owner=backend，due=2026-03-04 |
| F5 | P2 | `choices[]` 空数组无防护 | **待修复** |
| F6a | P3 | read_file + model_client 缺测试 | **待补齐** |
| F6b | P3 | tool loop 前端状态流转测试、WebSocket 集成测试 | **延至 M1.4**，owner=backend，due=2026-03-04 |

本次修复范围：F1 + F5 + F6a。
F4 流式回退属功能增强，涉及 agent loop 重构（流式聚合 tool_calls delta），
M1.3 已于 2026-02-16 合并（f3dd51f），故 F4 排入 **M1.4**，owner=backend，due=2026-03-04。

---

## F1: read_file workspace 边界绕过（P1）

**问题**: `read_file.py:56` 使用 `str(target).startswith(str(self._workspace_dir))` 做边界校验。
若 workspace 为 `/tmp/ws`，攻击路径解析到 `/tmp/ws-evil/secret.txt` 即通过前缀匹配。
此外 `raw_path` 未做类型校验，`"path": null` 会导致 `None.startswith("/")` 抛 `AttributeError`。

### 改动

**1. `src/tools/builtins/read_file.py:43-46`** — 加 path 类型校验

```python
# before
raw_path = arguments.get("path", "")

# Reject absolute paths
if raw_path.startswith("/"):

# after
raw_path = arguments.get("path", "")

# Reject non-string or empty path
if not isinstance(raw_path, str) or not raw_path:
    return {
        "error_code": "INVALID_ARGS",
        "message": "path must be a non-empty string.",
    }

# Reject absolute paths
if raw_path.startswith("/"):
```

**2. `src/tools/builtins/read_file.py:56`** — 换用 `is_relative_to`

```python
# before
if not str(target).startswith(str(self._workspace_dir)):

# after
if not target.is_relative_to(self._workspace_dir):
```

`Path.is_relative_to()` 自 Python 3.9 起可用，项目要求 3.12+，无兼容问题。
语义精确：基于路径组件比较而非字符串前缀，杜绝前缀碰撞。

---

## F5: model_client `choices[]` 空数组防护（P2）

**问题**: `model_client.py` 三处裸访问 `response.choices[0]`（line 122、145、171），
Ollama/vLLM 等兼容端点可能返回空 `choices`，触发 `IndexError`。

### 改动

**1. `src/agent/model_client.py`** — 新增私有校验方法

```python
@staticmethod
def _first_choice(response, *, context: str = ""):
    """Extract first choice from response, raising LLMError if empty."""
    if not response.choices:
        raise LLMError(f"Empty choices from provider ({context})")
    return response.choices[0]
```

**2. 三处调用点统一替换**

`chat()` (line 122):
```python
# before
content = response.choices[0].message.content or ""

# after
content = self._first_choice(response, context="chat").message.content or ""
```

`chat_stream()` (line 145):
```python
# before
delta = chunk.choices[0].delta

# after
if not chunk.choices:
    continue
delta = chunk.choices[0].delta
```

注：stream chunk 的 `choices` 为空是正常现象（如 OpenAI 的 `[DONE]` 前最后一个 chunk），
因此用 `continue` 跳过而非抛异常。

`chat_completion()` (line 171):
```python
# before
message = response.choices[0].message

# after
message = self._first_choice(response, context="chat_completion").message
```

---

## F6a: 补 read_file 安全测试 + model_client 防护测试（P3）

**问题**: F1 和 F5 的改动均涉及关键路径，必须有对应测试覆盖。

### 改动一：新建 `tests/test_read_file_security.py`

read_file 是唯一涉及文件系统的工具，边界逃逸是 P1 漏洞。

覆盖以下场景：

| 用例 | 输入 | 期望 |
|------|------|------|
| 正常读取 | `{"path": "test.md"}` | 返回 content |
| 绝对路径拒绝 | `{"path": "/etc/passwd"}` | ACCESS_DENIED |
| `..` 逃逸拒绝 | `{"path": "../../etc/passwd"}` | ACCESS_DENIED |
| 前缀碰撞拒绝 | workspace=`/tmp/ws`，target 解析到 `/tmp/ws-evil/x` | ACCESS_DENIED |
| 空路径拒绝 | `{"path": ""}` | INVALID_ARGS |
| null 路径拒绝 | `{"path": null}` | INVALID_ARGS |
| path 缺失 | `{}` | INVALID_ARGS |
| 文件不存在 | `{"path": "nonexistent.md"}` | FILE_NOT_FOUND |
| 符号链接逃逸拒绝 | workspace 内 symlink 指向 workspace 外 | ACCESS_DENIED |

测试使用 `tmp_path` fixture 构造隔离的 workspace 目录，无需真实文件系统依赖。

### 改动二：新建 `tests/test_model_client_choices_guard.py`

覆盖 F5 三处改动点：

| 用例 | 场景 | 期望 |
|------|------|------|
| chat 空 choices | mock response `choices=[]` | 抛 `LLMError`，包含 "Empty choices" |
| chat_completion 空 choices | mock response `choices=[]` | 抛 `LLMError`，包含 "Empty choices" |
| chat_stream 空 chunk choices | mock stream chunk `choices=[]` | 安全跳过，不中断流，不抛异常 |
| chat 正常 choices | mock response `choices=[valid]` | 正常返回 content |
| chat_completion 正常 choices | mock response `choices=[valid]` | 正常返回 message |

测试 mock `AsyncOpenAI` client，不消耗 API quota。

---

## 文件变更汇总

| 文件 | 改动项 |
|------|--------|
| `src/tools/builtins/read_file.py` | F1: path 类型校验 + `is_relative_to` |
| `src/agent/model_client.py` | F5: `_first_choice` 方法 + 三处调用替换 |
| `tests/test_read_file_security.py` | F6a: 新建，9 组 read_file 安全测试 |
| `tests/test_model_client_choices_guard.py` | F6a: 新建，5 组 choices 防护测试 |

共 **4 个文件**：2 个修改，2 个新建。

## 提交顺序

```
1. fix(tools): prevent read_file workspace boundary bypass via path traversal
   - is_relative_to 替换 startswith
   - 非字符串/空路径校验
2. fix(agent): guard against empty choices from LLM provider
   - _first_choice 方法 + stream chunk 跳过
3. test(tools): add read_file security boundary tests
   - 9 组用例覆盖路径逃逸、类型异常、符号链接
4. test(agent): add model_client empty choices guard tests
   - 5 组用例覆盖 chat/chat_completion 抛异常 + chat_stream 安全跳过
```

## 验证

```bash
uv run pytest tests/test_read_file_security.py tests/test_model_client_choices_guard.py -v
uv run pytest tests/ -v
uv run ruff check src/tools/builtins/read_file.py src/agent/model_client.py tests/test_read_file_security.py tests/test_model_client_choices_guard.py
```

## 不在本次范围

| 项目 | 去向 | 说明 |
|------|------|------|
| F4 token 级流式恢复 | **M1.4**，owner=backend，due=2026-03-04 | 涉及 agent loop 重构（流式聚合 tool_calls delta）；M1.3 已于 2026-02-16 合并（f3dd51f），故排入下一里程碑 |
| F6b: tool loop 前端状态流转测试 | **M1.4**，owner=backend，due=2026-03-04 | 需 WebSocket 集成测试 fixture，与 F4 流式重构一同交付 |
| `_execute_tool` 重复解析优化 | 可选 | 非 bug，属重构，可选择性在 F1 提交中顺带处理 |
