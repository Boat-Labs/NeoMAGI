# M1.1 评审问题修复计划 v4

## Context

v3 计划已实施并提交。本次为 v3 实现的 code review 修复，共 2 项发现：

- **High**: `agent.py:117` 日志行 `tc.function.arguments[:200]` 对 `None` 参数崩溃，F2 回归
- **Low**: 新增测试文件有未使用导入，lint 不干净

---

## R1: 日志行 None 参数崩溃（HIGH）

**问题**: `_safe_parse_args` 已正确处理 `None`（`json.loads(None)` → `TypeError` → 返回空 dict），
但紧接其后的日志行 `raw_args=tc.function.arguments[:200]` 在 `arguments=None` 时抛
`TypeError: 'NoneType' object is not subscriptable`。错误处理路径自身会炸，F2 修复名存实亡。

**触发前提**: OpenAI-compatible 提供方（Ollama、Gemini）在无参数 tool call 时可能返回 `null`
而非 `"{}"`，符合 CLAUDE.md 中"Gemini/Ollama 走 OpenAI-compatible 接口"的假设。

### 改动

**1. `src/agent/agent.py:117`** — 安全截断

```python
# before
raw_args=tc.function.arguments[:200],

# after
raw_args=str(tc.function.arguments)[:200],
```

`str(None)` → `"None"`，安全截断；正常字符串 `str("...")` 无额外开销。

**2. `src/agent/agent.py:21`** — 函数签名对齐实际调用

```python
# before
def _safe_parse_args(raw: str) -> tuple[dict, str | None]:

# after
def _safe_parse_args(raw: str | None) -> tuple[dict, str | None]:
```

调用方 `tc.function.arguments` 在 OpenAI-compatible 提供方下可能为 `None`，
签名需反映这一事实，否则 mypy/pyright 会对调用点和测试报类型错误。

**3. `tests/test_agent_tool_parse.py`** — 补 None 参数用例

在 `TestSafeParseArgs` 中新增：

```python
def test_none_arguments(self):
    result, err = _safe_parse_args(None)
    assert result == {}
    assert err is not None
```

在 `TestHandleMessageWithBadArgs` 中新增或修改一个用例，mock `tc.function.arguments = None`，
验证 `handle_message` 不崩溃且日志正常输出。

---

## R2: 测试文件未使用导入（LOW）

**问题**: 5 个未使用导入，`ruff check` 会报 F401。

### 改动

| 文件 | 移除 | 说明 |
|------|------|------|
| `tests/test_agent_tool_parse.py:5` | `patch` from `from unittest.mock import AsyncMock, MagicMock, patch` | 只保留 `AsyncMock, MagicMock` |
| `tests/test_agent_tool_parse.py:8` | `import pytest_asyncio` | 当前测试只用 `pytest.mark.asyncio` |
| `tests/test_config_schema.py:6` | `import os` | `monkeypatch` 已替代 |
| `tests/test_session_history_filter.py:5` | `UTC` from `from datetime import UTC, datetime` | 只保留 `datetime` |
| `tests/test_session_history_filter.py:6` | `patch` from `from unittest.mock import AsyncMock, MagicMock, patch` | 只保留 `AsyncMock, MagicMock` |

注：review 原文标注 `test_agent_tool_parse.py:5` 的 `AsyncMock` 为未使用，经核实 `AsyncMock`
在 `TestExecuteToolDictValidation` 和 `TestHandleMessageWithBadArgs` 中均有引用，属误报。

---

## 文件变更汇总

| 文件 | 改动项 |
|------|--------|
| `src/agent/agent.py` | R1: 日志安全截断 `str(...)[:200]` + 签名 `raw: str \| None` |
| `tests/test_agent_tool_parse.py` | R1: 补 None 参数用例; R2: 移除 `pytest_asyncio`, `patch` |
| `tests/test_config_schema.py` | R2: 移除 `os` |
| `tests/test_session_history_filter.py` | R2: 移除 `UTC`, `patch` |

共 **4 个文件**，均为修改，无新建。

## 提交顺序

```
1. fix(agent): use safe str truncation for None tool call arguments in log
2. chore: remove unused imports from review-fix test files
```

## 验证

```
uv run pytest tests/test_agent_tool_parse.py tests/test_config_schema.py tests/test_session_history_filter.py -v
uv run ruff check tests/test_agent_tool_parse.py tests/test_config_schema.py tests/test_session_history_filter.py
```
