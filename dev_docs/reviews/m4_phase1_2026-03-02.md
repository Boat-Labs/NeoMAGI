# M4 Phase 1 Acceptance Report

> Gate: m4-g1 | Phase: 1 | Target: e48ca51c62c31d5559ca7ab4c3d3d5bd19c1f358
> Reviewer: tester | Date: 2026-03-02

## Conclusion: PASS

All P1 requirements are met. 608 tests green, ruff clean. dispatch_chat correctly extracted as channel-agnostic core. AgentLoop identity/scope propagation is correct with backward compatibility. SESSION_BUSY and BUDGET_EXCEEDED propagate as GatewayError. session_id/scope_key separation is clean.

---

## Test Evidence

| Suite | Result |
|-------|--------|
| `uv run pytest tests/ -v` | 608 passed in 13.73s |
| `just lint` (ruff) | Clean, no errors |

### New Tests (12 total)
- `tests/test_dispatch.py`: 8 tests (normal dispatch, SESSION_BUSY, BUDGET_EXCEEDED, session_id passthrough, identity/dm_scope passthrough)
- `tests/test_agent_identity.py`: 4 tests (Telegram identity, backward compat, dm_scope override, flush scope passthrough)

### Adapted Tests
- `tests/test_budget_gate_wiring.py`: import path updated (DEFAULT_RESERVE_EUR from dispatch.py), settle logging patched to dispatch.logger, SESSION_BUSY now asserts GatewayError
- `tests/test_eval_run_id.py`: import path updated (_extract_eval_run_id from dispatch.py)
- `tests/test_session_serialization.py`: SESSION_BUSY now asserts GatewayError (was inline JSON check)
- `tests/test_agent_flush_persist.py`: all 6 call sites updated with `scope_key=` param, `test_scope_key_from_candidate_session_id` renamed to `test_scope_key_used_directly` verifying caller-provided scope

---

## Requirement-Evidence Matrix

| # | Requirement (from Plan P1) | Evidence | Status |
|---|---------------------------|----------|--------|
| R1 | `dispatch_chat()` encapsulates full flow (provider routing → session claim → budget reserve → handle_message → settle → release) | `src/gateway/dispatch.py:47-141` — complete flow with finally block for settle+release | PASS |
| R2 | SESSION_BUSY propagates as GatewayError (not WS-specific format) | `dispatch.py:86-89` raises `GatewayError(code="SESSION_BUSY")`; `test_dispatch.py:141-157` + `test_budget_gate_wiring.py:250-266` + `test_session_serialization.py:43-58` all assert `pytest.raises(GatewayError)` | PASS |
| R3 | BUDGET_EXCEEDED propagates as GatewayError | `dispatch.py:103-104` raises `GatewayError(code="BUDGET_EXCEEDED")`; `test_dispatch.py:165-181` asserts | PASS |
| R4 | `handle_message` accepts identity + dm_scope params, None backward compat | `agent.py:223-231` new optional params; `agent.py:259-263` effective_identity/effective_dm_scope with fallback; `test_agent_identity.py:46-108` covers both paths | PASS |
| R5 | `_persist_flush_candidates` uses explicit scope_key param (no re-resolve) | `agent.py:823-828` `scope_key: str` param; `agent.py:839` uses `scope_key` directly; `test_agent_flush_persist.py:116-140` verifies caller-provided scope_key used over candidate session_id | PASS |
| R6 | WebSocket path session_id passthrough (no resolver) | `app.py:244-251` passes `parsed.session_id` directly to `dispatch_chat`; `test_budget_gate_wiring.py:200-207` asserts `session_id="my-session"` passthrough | PASS |
| R7 | session_id / scope_key separation | `dispatch.py` uses session_id for claim/budget/load; identity+dm_scope passed to handle_message for scope_key resolution in AgentLoop; two concerns cleanly separated | PASS |
| R8 | 608 tests green (+12 new), ruff clean | 608 passed, 0 failures, ruff clean | PASS |
| R9 | Budget gate wiring assertions unchanged | `test_budget_gate_wiring.py` all 11 tests pass with updated imports; session_id="my-session" passthrough preserved | PASS |

---

## Findings

### F1: dispatch_chat signature vs plan minor divergence (INFO)
Plan specifies `identity: SessionIdentity` and `dm_scope: str` as required positional; implementation uses `identity: SessionIdentity | None = None` and `dm_scope: str | None = None` as optional keyword-only. This is actually better — it preserves backward compatibility for the WebSocket path which doesn't pass identity/dm_scope. The WebSocket caller in `app.py:244-251` doesn't pass them, and AgentLoop falls back to defaults. **Not a defect.**

### F2: dm_scope None check uses `is not None` vs `or` (INFO)
`agent.py:262`: `dm_scope if dm_scope is not None else self._session_settings.dm_scope`. This correctly handles the edge case where `dm_scope=""` would be falsy but is an intentional value (though currently no empty-string scope is valid). Correct design choice.

### F3: _extract_eval_run_id moved to dispatch.py (INFO)
Moved from `app.py` to `dispatch.py` — correct location since it's used by `dispatch_chat`. Import path updated in `test_eval_run_id.py`. Clean refactor.

### F4: Settle uses fixed DEFAULT_RESERVE_EUR for actual_cost (INFO)
`dispatch.py:123`: `actual_cost_eur=DEFAULT_RESERVE_EUR` (same as reserve). Plan note: "[ADR 0041] Phase 1: fixed per-request cost estimate." This is documented as intentional — accurate per-model pricing deferred. **Not a defect.**

### F5: WebSocket path does not pass identity/dm_scope to dispatch_chat (INFO)
`app.py:244-251`: WebSocket handler calls `dispatch_chat` without `identity` or `dm_scope`. AgentLoop then defaults to `SessionIdentity(session_id, channel_type="dm")` + `self._session_settings.dm_scope` (="main"). This preserves existing WebChat behavior exactly. Future Telegram adapter will pass explicit identity/dm_scope. **Correct by design.**

---

## Residual Risks

| Risk | Severity | Mitigation |
|------|----------|------------|
| Integration tests skipped (testcontainers not in worktree venv by default) | LOW | Unit tests cover dispatch logic fully; integration tests are DB-dependent and unchanged in this phase |
| dispatch_chat does not validate identity/dm_scope consistency | LOW | Validation happens in resolve_scope_key (ValueError for missing peer_id); Telegram adapter (P2) will construct valid identity |
| Budget settle always uses fixed €0.05 regardless of actual usage | LOW | Documented as intentional ADR 0041 Phase 1 decision; accurate pricing is deferred |

---

## Gate Recommendation

**PASS** — All 7 core acceptance criteria met with evidence. No P0/P1 issues found. 608 tests green, ruff clean. dispatch_chat is ready for Phase 2 (Telegram Adapter) consumption.

Recommend PM proceed to gate-close for m4-g1 and open Phase 2 gate.
