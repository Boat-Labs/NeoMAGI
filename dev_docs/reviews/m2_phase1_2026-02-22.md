# M2 Phase 1 Gate 验收报告

> 日期：2026-02-22
> 审查人：Tester
> Commit：ed5712b (`feat(agent): implement token budget infrastructure for M2`)
> 分支：feat/backend-m2-session-continuity → merged into feat/test-m2-session-continuity
> 验证环境：tester worktree `/Users/zhiliangzhou/devel/Zhiliang/NeoMAGI-wt-tester-m2`

## 结论：PASS

Phase 1 核心实现完整、逻辑正确、行为不变（仅观测路径）。测试覆盖充分（37 个新测试全部通过），代码质量高，符合 Plan 和 ADR 约束。

## Findings

| # | 严重度 | 描述 | 文件:行号 | 状态 |
|---|--------|------|-----------|------|
| 1 | P2 | `TokenCounter.__init__` 的异常捕获使用 `except (KeyError, Exception)`，`Exception` 已覆盖 `KeyError`，`KeyError` 冗余。功能不受影响，纯代码卫生。 | src/agent/token_budget.py:39 | open |
| 2 | P2 | 测试文件有 2 个 ruff lint 错误（仅 `tests/`，不影响 `just lint` 的 `src/` 范围）：(1) `test_agent_budget_smoke.py:14` 未使用 import `TextChunk`（F401）；(2) `test_token_budget.py:9` imports 未排序（I001）。均为 auto-fixable。 | tests/test_agent_budget_smoke.py:14, tests/test_token_budget.py:9 | open |
| 3 | Info | `_MSG_OVERHEAD_TOKENS = 4` 和 `_REPLY_PRIMING_TOKENS = 3` 为 OpenAI chat format 的经验常量，与 tiktoken cookbook 一致。当前合理。 | src/agent/token_budget.py:16-18 | closed |

## Requirement-Evidence Matrix

| 需求 | 验证方法 | 证据 | 结果 |
|------|----------|------|------|
| `just test` 通过（含 token budget + smoke 测试） | `uv run pytest tests/ -v -m "not integration" -x` | **160 passed**, 26 deselected in 1.78s。含 37 个新增 Phase 1 测试（22 test_token_budget + 5 test_agent_budget_smoke + 10 CompactionSettings）全部通过。 | **PASS** |
| `just lint` 通过 | `uv run ruff check src/` | All checks passed! | **PASS** |
| 日志字段完整：current_tokens, status, usable_budget, warn_threshold, compact_threshold, tokenizer_mode | agent loop 烟雾测试 `test_budget_check_log_emitted` + `test_budget_status_values` | 9 个字段全部存在且类型正确：session_id=test-session, model=gpt-4o-mini, iteration=0, current_tokens=64, status=ok, usable_budget=1700, warn_threshold=1360, compact_threshold=1530, tokenizer_mode=exact | **PASS** |
| 未引入行为变更（仅观测路径） | 代码审查 + `test_no_budget_check_without_settings` 测试 | (1) agent.py 中 budget_status 仅用于 `logger.info`，无 if 分支改变控制流；(2) `compact_needed` 字符串不出现在 agent.py 控制流中；(3) 不提供 compaction_settings 时无 budget_check 日志（测试验证） | **PASS** |
| CompactionSettings ratio 校验覆盖（warn >= compact 报错、负值报错、usable <= 0 报错） | 测试 `TestCompactionSettings`（8 个测试用例） | (1) warn_ratio > compact_ratio → ValueError ✓；(2) warn_ratio == compact_ratio → ValueError ✓；(3) warn_ratio=0 → ValueError ✓；(4) warn_ratio=-0.1 → ValueError ✓；(5) compact_ratio=1.0 → ValueError ✓；(6) usable<=0 → ValueError ✓ | **PASS** |
| 代码审查：TokenCounter fallback 逻辑正确 | 测试 `TestTokenCounterFallbackMode`（5 个用例）+ 代码审查 | (1) gpt-4o-mini → mode=exact ✓；(2) unknown-model → mode=estimate + structlog.warning ✓；(3) estimate 使用 `ceil(len/4)` ✓ | **PASS** |
| BudgetStatus 结构与 plan 一致 | 测试 `test_budget_status_fields_complete` + dataclass 字段验证 | 6 个字段完全匹配 Plan 3.3：status, current_tokens, usable_budget, warn_threshold, compact_threshold, tokenizer_mode | **PASS** |
| ADR 0029 一致性（exact/estimate 模式标记） | 测试 `test_tokenizer_mode_propagated_exact/estimate` + `test_budget_check_tokenizer_mode_exact/estimate` | (1) TokenCounter.tokenizer_mode 返回 Literal["exact", "estimate"] ✓；(2) BudgetStatus.tokenizer_mode 正确传递 ✓；(3) budget_check 日志含 tokenizer_mode ✓ | **PASS** |
| 预算公式与 m2_architecture.md 3.1 对齐 | 测试 `test_budget_status_values` + 数值验证 | usable=10000-1000-500=8500; warn=int(8500*0.80)=6800; compact=int(8500*0.90)=7650。测试断言完全匹配。 | **PASS** |
| tiktoken 依赖添加 | pyproject.toml 审查 | `tiktoken>=0.7.0` 已添加到 dependencies | **PASS** |
| Root Settings 组合 | settings.py 审查 | `compaction: CompactionSettings = Field(default_factory=CompactionSettings)` 已添加到 `Settings` | **PASS** |
| AgentLoop 向后兼容 | 测试 `test_no_budget_check_without_settings` | `compaction_settings: CompactionSettings | None = None`，未提供时无任何 budget 行为 | **PASS** |

## 测试清单对照

| Plan 要求的测试覆盖 | 实际测试 | 结果 |
|---------------------|----------|------|
| TokenCounter: 多 encoding | `test_exact_mode_for_openai_model` | ✓ |
| TokenCounter: 中英文混合 | `test_count_text_english`, `test_count_text_chinese`, `test_count_text_mixed` | ✓ |
| TokenCounter: fallback 触发（mode=estimate） | `TestTokenCounterFallbackMode` (5 tests) | ✓ |
| TokenCounter: tools schema 计数 | `test_count_tools_schema`, `test_count_tools_schema_empty` | ✓ |
| TokenCounter: per-message overhead | `test_count_messages_basic` (asserts tokens > text_only) | ✓ |
| TokenCounter: system message overhead | `test_count_messages_with_system` | ✓ |
| BudgetTracker: 边界值（刚好 warn/compact） | `test_warn_boundary_exact`, `test_compact_boundary_exact` | ✓ |
| BudgetTracker: 配置覆盖 | `test_ok_status` uses custom settings | ✓ |
| BudgetTracker: BudgetStatus 全字段完整性 | `test_budget_status_fields_complete` | ✓ |
| CompactionSettings: warn >= compact 报错 | `test_warn_ratio_must_be_less_than_compact_ratio`, `test_warn_ratio_equal_to_compact_ratio_rejected` | ✓ |
| CompactionSettings: 负值报错 | `test_warn_ratio_negative_rejected`, `test_warn_ratio_zero_rejected` | ✓ |
| CompactionSettings: usable <= 0 报错 | `test_usable_budget_must_be_positive` | ✓ |
| Agent loop 烟雾: budget_check 日志字段完整 | `test_budget_check_log_emitted` | ✓ |
| Agent loop 烟雾: tokenizer_mode=exact | `test_budget_check_tokenizer_mode_exact` | ✓ |
| Agent loop 烟雾: tokenizer_mode=estimate | `test_budget_check_tokenizer_mode_estimate` | ✓ |
| Agent loop: 无 settings 时无 budget log | `test_no_budget_check_without_settings` | ✓ |

## Residual Risks

1. **测试文件 lint 警告 (P2)**：2 个 auto-fixable lint 错误在 `tests/`。不阻塞功能，但建议 Backend 在下次 commit 时修复（`ruff check --fix tests/`）。
2. **`except (KeyError, Exception)` 冗余 (P2)**：不影响功能，但在代码审查中属于不规范写法。

## Gate 建议

**放行**。

所有 Gate 1 验收标准全部满足：
- 160 个单元测试通过（含 37 个新增 Phase 1 测试）
- `just lint` 通过
- 日志字段完整性验证通过
- 仅观测路径确认（无行为变更）
- CompactionSettings 校验全路径覆盖
- ADR 0029 一致性确认
- 代码结构与 Plan 完全对齐

P2 级别的 2 个 findings 不阻塞放行，建议 Backend 在 Phase 2 开发中顺带修复。
