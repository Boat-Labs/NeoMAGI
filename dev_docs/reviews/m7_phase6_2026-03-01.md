# M7 Phase 6 Review

- Milestone: `M7`
- Phase: `6`
- Gates:
  - `G-M7-P6-NEG`
  - `G-M7-P6-POS`
- Reviewer role: `pm`
- Review date: `2026-03-01`
- Result: `PASS`

## Scope

本轮只验证一条新的最小 hardening 规则是否足够有效：

- Claude Code teammate 在任何 devcoord 写操作前，必须先校验 `git rev-parse HEAD == target_commit`

目标不是做完整 phase cutover，而是用同一个 fresh backend worktree 跑一组负对照和正对照：

- 负对照：`HEAD != target_commit` 时，不应写入 `ACK`
- 正对照：`HEAD == target_commit` 时，允许写入 `ACK`

## Environment

- Backend worktree: `codex/backend-m7-preflight-clean`
- Backend worktree HEAD: `255da2f`
- Claude Code CLI: slash skill `/devcoord-backend`

## Evidence

- Negative control debug:
  - `/tmp/devcoord-backend-p6neg.debug`
- Positive control debug:
  - `/tmp/devcoord-backend-p6pos.debug`
  - `/tmp/devcoord-backend-p6pos-bypass.debug`
- Live audit checkpoints:
  - after negative control: `received_events=75`, `pending_ack_messages=[G-M7-P6-NEG]`
  - after positive control: `received_events=78`, `pending_ack_messages=[G-M7-P6-NEG]`, `G-M7-P6-POS=open`

## Findings

- `G-M7-P6-NEG`:
  - PM opened gate with `target_commit=cd6e40f`
  - backend worktree `HEAD=255da2f`
  - Claude Code skill 命中成功，debug 中出现 `Metadata string for devcoord-backend` 与 `processPromptSlashCommand`
  - Claude Code 明确回报 `HEAD != target_commit`，并停止写入；控制面没有新增 backend `ACK`
- `G-M7-P6-POS`:
  - PM opened gate with `target_commit=255da2f`
  - backend worktree `HEAD=255da2f`
  - 首次 non-bypass run 停在 CLI permission confirmation，没有误写
  - 在同一 worktree 下使用 `--dangerously-skip-permissions` 重跑后，Claude Code 真实写入 backend `ACK`，并把 gate 推进到 `open`

## Conclusion

这条最小 preflight 规则已经足够把 `P4` 暴露出的核心风险收窄一层：

- skill 命中本身不再自动等价于“允许写控制面”
- 即使 Claude Code 准备执行写命令，只要当前 worktree `HEAD` 与 PM 的 `target_commit` 不一致，就会停在阻塞态而不是误写 `ACK`
- 当 `HEAD == target_commit` 时，backend 写路径仍可正常推进

因此，`G-M7-P6-NEG` 与 `G-M7-P6-POS` 都可按 `PASS` 关闭。
