# M7 Phase 1 Gate Review

- Gate: G-M7-P1
- Scope: M7 Phase 1 control plane skeleton
- Reviewer: PM
- Date: 2026-03-01
- Reviewed workspace state: current working tree based on Phase 1 baseline commit `b8ba773`

## 结论: PASS

Phase 1 目标已经满足：`scripts/devcoord` 提供统一 wrapper 和直接脚本入口，控制面状态写入 beads，`dev_docs/logs/` 可由 render 重建；最小链路 `open-gate -> ack -> heartbeat -> phase-complete -> render` 已经在 live `.beads` 与自动化测试中验证可用，结构化 payload 入口也已有回归覆盖。

## Gate G-M7-P1 验收条件

| 条件 | 结果 | 证据 |
|------|------|------|
| `scripts/devcoord/coord.py` 实现最小命令集 | PASS | `init / open-gate / ack / heartbeat / phase-complete / render` 已实现；额外补入 `gate-review / gate-close` |
| beads 交互固定为 `bd ...` CLI shell-out | PASS | `CliIssueStore` 统一负责 `bd list/create/update`，未直接写 Dolt SQL |
| wrapper 默认复用共享控制面，不分裂 `.beads` | PASS | 自动优先使用仓库根 `.beads`；live 环境已复用现有 `NeoMAGI/.beads` |
| `dev_docs/logs/*` 可由 render 重建 | PASS | `dev_docs/logs/m7_2026-03-01/heartbeat_events.jsonl`、`gate_state.md`、`watchdog_status.md` 已生成 |
| 基本协议不变量可测 | PASS | 负向测试覆盖无 pending message 不允许 ACK；事件序号单调递增 |
| lint / unit test 通过 | PASS | `uv run pytest tests/test_devcoord.py -v`、`uv run ruff check scripts/devcoord/coord.py tests/test_devcoord.py` |
| live `.beads` smoke 成功 | PASS | 已写入 `milestone / phase / gate / agent / message / event` 对象，并成功渲染 projection |

## Requirement-Evidence Matrix

| 需求 | 实现位置 | 证据 | 状态 |
|------|---------|------|------|
| 统一控制面入口 | `scripts/devcoord/coord.py` | CLI 子命令 + `apply` 结构化入口 + `run_cli()` | PASS |
| shell-out beads 适配层 | `scripts/devcoord/coord.py` | `CliIssueStore` | PASS |
| 共享控制面路径解析 | `scripts/devcoord/coord.py` | `_resolve_paths()` 优先复用仓库根 `.beads` | PASS |
| append-only 事件序列 | `scripts/devcoord/coord.py` | `_record_event()` + `_next_event_seq()` | PASS |
| ACK 未生效前不得视为 effective | `scripts/devcoord/coord.py` | `_find_pending_message()` + `ack()` fail-closed | PASS |
| projection 重建 | `scripts/devcoord/coord.py` | `render()` + `_render_gate_state()` + `_render_watchdog()` | PASS |
| 结构化 payload 入口 | `scripts/devcoord/coord.py` + `tests/test_devcoord.py` | `apply --payload-file / --payload-stdin` 已覆盖；`just` 包装层已移除出 devcoord 正式写路径 | PASS |
| gate review / close 闭环能力 | `scripts/devcoord/coord.py` | `gate_review()` + `gate_close()`，单测覆盖 | PASS |

## 验证摘要

### 单元与静态检查

```bash
uv run pytest tests/test_devcoord.py -v
uv run ruff check scripts/devcoord/coord.py tests/test_devcoord.py
```

结果：
- 6 tests passed
- ruff clean

### Live Control Plane Smoke

真实 `.beads` 上的最小事件流已经落地；当前通过直接脚本入口执行无副作用 `render` 校验，投影结果与控制面状态一致：

```bash
uv run python scripts/devcoord/coord.py apply render --payload-file /tmp/m7_render_payload.json
```

生成结果：
- `dev_docs/logs/m7_2026-03-01/heartbeat_events.jsonl`：5 条事件，覆盖 `GATE_OPEN_SENT -> ACK -> GATE_EFFECTIVE -> HEARTBEAT -> PHASE_COMPLETE`
- `dev_docs/logs/m7_2026-03-01/gate_state.md`：`G-M7-P1` 当前为 `open`
- `dev_docs/logs/m7_2026-03-01/watchdog_status.md`：backend=`done`，tester=`idle`

## Code Review 要点

### 架构边界
- beads 仅作为 persistence/query/history 后端，协议语义仍集中在 `CoordService`，与 ADR 0042 和 `beads_control_plane.md` 对齐。
- `scripts/devcoord -> bd CLI` 边界清楚，没有把 `bd` 命令拼装暴露给上层使用者；ADR 0043 已将 `just` 从 devcoord 正式写路径中移除。
- control plane 失败默认 fail-closed；缺少 `bd`/`dolt`、缺少 gate、缺少 pending message 都会直接报错。

### 协议实现
- `open-gate` 会同时写 gate bead、pending message bead、`GATE_OPEN_SENT` 事件，并把目标 agent 置为 `spawning`。
- `ack` 只会消费 pending command；ACK 后才把 message 标记为 effective，并写入 `ACK` / `GATE_EFFECTIVE`。
- `heartbeat` 与 `phase-complete` 会同时维护 agent 聚合状态和 append-only event。
- `gate-review` / `gate-close` 已能承载真实验收结果，但 live 执行仍要求先有真实 report commit。

### 兼容投影
- `heartbeat_events.jsonl` 字段已对齐现有日志口径：`ts / role / phase / status / task / event / gate / target_commit / event_seq / eta_min`，并按需附加 `ack_of / branch / result / report_commit / report_path / source_msg_id`。
- `gate_state.md` 和 `watchdog_status.md` 输出已可直接给人工审阅使用。

## Findings

### P0
无。

### P1
无。

### P2
1. `dev_docs/progress/project_progress.md` 的 control plane projection 还未实现；当前 Phase 1 不阻塞，但后续 cutover 前需要定稿更新策略。
2. `recovery-check / state-sync-ok / stale-detected / gate-close fail-guards` 还未全部落地；属于 Phase 1 之后的扩展协议面。

## Residual Risks

1. live `G-M7-P1` 当前仍保持 `open`，不是实现缺陷，而是因为验收报告尚未 commit，尚不满足真实 `coord-gate-review` / `coord-gate-close` 的证据前提。
2. 本轮 live smoke 是最小单角色顺序路径，尚未覆盖 recovery、respawn、re-review、watchdog 超时等边界场景。

## Gate 建议

**PASS** — M7 Phase 1 skeleton 已达到可进入下一步集成的状态。建议先提交当前实现与本 review 文件，然后用该提交的 `report_commit` 执行 live `coord-gate-review` 与 `coord-gate-close`，把 `G-M7-P1` 从 `open` 收口到 `closed`。
