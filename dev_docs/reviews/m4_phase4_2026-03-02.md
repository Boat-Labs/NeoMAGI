# M4 Phase 4 Acceptance Report — E2E + Docs + ADR

> Gate: m4-g4-review | Phase: 4 | Target commit: db43d1d
> Reviewer: tester | Date: 2026-03-02
> Plan ref: `dev_docs/plans/m4_telegram-channel-integration_2026-03-02.md` Phase 4

## Conclusion: PASS

All 9 gate acceptance criteria verified. 668 tests green, ruff clean.
No P0/P1 findings. Two informational findings noted.

---

## Requirement-Evidence Matrix

| # | Requirement | Evidence | Status |
|---|------------|----------|--------|
| 1 | `tests/test_channel_isolation.py` 存在且测试通过 | 文件 399 行, 5 test classes / 11 test methods; `just test` 全通过 | PASS |
| 2 | scope_key 隔离: Telegram `telegram:peer:{id}` vs WebChat `main` | `TestScopeKeyIsolation` 3 tests — `test_telegram_dm_scope_key` 断言 `telegram:peer:111`; `test_webchat_scope_key` 断言 `main`; `test_telegram_and_webchat_scopes_differ` 断言两者不等 | PASS |
| 3 | session 隔离: 同用户同 session; 不同用户不同 session | `TestSessionIsolation` 3 tests — `test_same_user_same_session` peer_id=100 两次一致; `test_different_users_different_sessions` peer_id 100 vs 200 不同; `test_telegram_session_key_format` 断言格式 `telegram:peer:555` | PASS |
| 4 | memory scope 互不可召回 | `TestMemoryScopeIsolation.test_telegram_flush_scope_differs_from_webchat` — 分别以 `telegram:peer:42` 和 `main` scope flush, 验证 daily note 中两个 scope tag 共存且内容各自关联 | PASS |
| 5 | tool mode / risk gating 一致性 | `TestToolModeConsistency` 2 tests — `test_telegram_dispatch_uses_same_mode_path` 验证 dispatch_chat 不注入 channel-specific mode; `test_agent_loop_mode_independent_of_channel` 验证 get_mode 仅按 session_id 调用, 无 channel 逻辑 | PASS |
| 6 | flush persist scope 一致性 | `TestFlushPersistScopeConsistency` 2 tests — `test_flush_scope_matches_recall_scope` 验证 flush scope_key == resolve_scope_key 产出; `test_dispatch_passes_consistent_identity_and_scope` 验证 dispatch 透传 identity/dm_scope 到 handle_message, derived scope == session_id | PASS |
| 7 | ADR 0044 存在且内容完整 | `decisions/0044-telegram-adapter-aiogram-same-process.md` 41 行 — 选了什么 (aiogram 3.x + 同进程 + per-channel-peer scope), 为什么 (3 条理由), 放弃了什么 (python-telegram-bot / 独立进程 / per-peer), 约束 (单 worker + fail-closed + 仅私聊) | PASS |
| 8 | 文档更新: m4_architecture.md, modules.md, m4_user_test_guide.md, INDEX.md | `m4_architecture.md` 63 行 (状态 implemented, 6 节完整); `modules.md` Channel Adapter 已更新为 "WebChat + Telegram 已实现（M4 完成）"; `m4_user_test_guide.md` 61 行 (Use Case A/B/C + 错误场景 + 日志); `INDEX.md` 含 ADR 0044 行 | PASS |
| 9 | 668 tests green, ruff clean | `just test`: 668 passed in 13.08s; `just lint`: All checks passed | PASS |

---

## Use Case Coverage

| Use Case | 验证方式 | Status |
|----------|---------|--------|
| A: Telegram 核心任务与 WebChat 体验一致 | `test_telegram_dispatch_uses_same_mode_path` 验证两渠道走同一 handle_message 路径; `test_agent_loop_mode_independent_of_channel` 验证 mode 查询无 channel 分支; 手工指南 `m4_user_test_guide.md` 覆盖端到端流程 | PASS |
| B: 渠道切换不改变能力边界 | `TestToolModeConsistency` 2 tests 覆盖 mode 一致性; dispatch_chat 统一入口保证 tool registry / risk gating / budget gate 共用 | PASS |
| C: 跨渠道隔离行为正确 | `TestScopeKeyIsolation` 3 tests (scope_key 不同); `TestSessionIsolation` 3 tests (session 隔离); `TestMemoryScopeIsolation` 1 test (memory flush scope 隔离); `TestFlushPersistScopeConsistency` 2 tests (flush/recall scope 一致) | PASS |

---

## Findings

### F1 (INFORMATIONAL) — memory scope 隔离测试依赖文件系统而非 DB

`test_channel_isolation.py:196-213`: `TestMemoryScopeIsolation` 通过 `_persist_flush_candidates` 写入 daily note 文件, 验证 `scope:` tag 的存在。这覆盖了 file-backed daily note 路径的 scope 隔离, 但未覆盖 DB-backed memory search 的 scope 过滤。

**影响**: 当前 M4 scope 只是 memory flush 端的隔离标记。DB recall scope 过滤由 `src/memory/searcher.py` 的 `scope_key` 参数保证, 已有独立测试覆盖 (非 P4 范围)。不影响 P4 验收。

### F2 (INFORMATIONAL) — test 使用内部方法 `_persist_flush_candidates`

`test_channel_isolation.py:196,338`: 测试直接调用 `AgentLoop._persist_flush_candidates()` (前缀 `_` 表示私有方法)。若后续重构该方法签名, 测试需同步更新。

**影响**: 这是 M4 测试策略的合理选择 — 避免触发完整 compaction pipeline, 精确验证 scope 传播。作为 isolation 测试, 使用内部方法合理。

---

## Residual Risks

| Risk | Severity | Mitigation |
|------|----------|------------|
| 手工端到端测试未在本轮执行 | LOW | `m4_user_test_guide.md` 提供完整步骤; 自动化测试已覆盖所有隔离维度; 部署前建议执行一次 Use Case A/B/C 手工验证 |
| daily note scope tag 无唯一性约束 | LOW | 同一 daily note 可能存在多个 scope 的记忆; recall 侧通过 `scope_key` 参数过滤, 不依赖 file 级隔离 |

---

## Gate Recommendation

**PASS** — 建议 PM 关闭 gate m4-g4-review。

P4 全部 9 项核心验收标准通过, 3 个 Use Case 覆盖完整, 668 tests 全绿, ruff clean。ADR 0044 和文档更新齐全。两个 INFORMATIONAL findings 不阻塞。
