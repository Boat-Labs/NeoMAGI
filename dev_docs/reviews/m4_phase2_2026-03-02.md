# M4 Phase 2 Acceptance Report — Telegram Adapter

> Gate: m4-g2 | Phase: 2 | Target commit: 436d2af
> Reviewer: tester | Date: 2026-03-02
> Plan ref: `dev_docs/plans/m4_telegram-channel-integration_2026-03-02.md` Phase 2

## Conclusion: PASS

All 10 gate acceptance criteria verified. 630 tests green, ruff clean.
No P0/P1 findings.

---

## Requirement-Evidence Matrix

| # | Requirement | Evidence | Status |
|---|------------|----------|--------|
| 1 | aiogram 依赖正确添加 | `pyproject.toml:19` — `"aiogram>=3.15.0"` in dependencies | PASS |
| 2 | TelegramAdapter 三方法完整 | `telegram.py:68` check_ready, `:80` start_polling, `:85` stop | PASS |
| 3 | 身份映射通过 resolver | `telegram.py:126` — `session_id = resolve_session_key(identity, dm_scope)` 非手工拼接; test `TestIdentityMapping` 3 cases 覆盖 | PASS |
| 4 | 鉴权 fail-closed | `telegram.py:104` — `user_id not in self._allowed_ids`; `_parse_allowed_ids("")` → `frozenset()` → 空白名单全拒; tests: `test_allowed_user_passes`, `test_denied_user_ignored`, `test_empty_whitelist_denies_all` | PASS |
| 5 | 非 DM (group) 消息忽略 | `telegram.py:94` — `ChatType.PRIVATE` check; tests: `test_group_message_ignored`, `test_supergroup_message_ignored` | PASS |
| 6 | DM 触发 dispatch_chat | `telegram.py:141-150` — 传入 `session_id`, `identity`, `dm_scope`, `content`, `session_claim_ttl_seconds`; test `test_dm_triggers_dispatch` 验证所有参数 | PASS |
| 7 | invalid token → check_ready fail-fast | `telegram.py:74-78` — `except Exception` → `raise ChannelError`; test `test_check_ready_failure_raises` | PASS |
| 8 | 空 bot_token 不启动 adapter | `app.py:163` — `if settings.telegram.bot_token:`; `test_empty_bot_token_skips_telegram` | PASS |
| 9 | done_callback 监听 polling fatal | `app.py:176-186` — `_on_polling_done` 检查 `task.exception()` 并 `logger.error` | PASS |
| 10 | 630 tests green, ruff clean | `just test`: 630 passed in 15.12s; `just lint`: All checks passed | PASS |

---

## Findings

### F1 (INFORMATIONAL) — typing indicator exception handling

`telegram.py:181-182`: `_typing_loop` 中 `send_chat_action` 异常仅 `logger.debug`。作为背景 typing indicator 这是合理的设计——失败不应阻断主流程。无需修改。

### F2 (INFORMATIONAL) — error fallback message 语言

`telegram.py:168`: 错误回退消息 `"An error occurred while processing your message."` 为英文。Plan Phase 3 覆盖中文错误消息映射，P2 可接受。

### F3 (LOW) — check_ready 无显式 timeout

`telegram.py:71`: `await self._bot.get_me()` 未设显式 timeout。CLAUDE.md 规范要求外部服务调用必须有 timeout。但 aiogram 内部使用 aiohttp 默认 timeout (300s)，实际风险低。建议 Phase 3 或后续 hardening 中加显式 timeout。

**Severity: LOW — 不阻塞 gate。**

---

## Code Quality Assessment

### 正面
- **符合计划设计**: TelegramAdapter 完全按 Phase 2.2 设计实现，identity 映射通过 resolver (ADR 0034)
- **fail-closed 安全模型**: 空白名单 → frozenset() → 全拒，个人 agent 安全优先
- **dispatch_chat 复用**: Telegram adapter 与 WebSocket 路径共享同一 dispatch 核心，无重复逻辑
- **生命周期清晰**: check_ready → start_polling → stop 三方法分离，lifespan 正确集成
- **typing indicator**: 后台 task + cancel 模式，finally block 确保清理
- **响应长度保护**: message_max_length 截断 (telegram.py:157-159)
- **非文本消息过滤**: `if not message.text: return` (telegram.py:113)
- **structlog 日志**: 全部使用 structlog，含结构化上下文

### 测试质量
- 21 个 Telegram 专项测试覆盖全部验收场景
- Mock 层次适当: dispatch_chat 用 patch side_effect 实现 async generator mock
- 边界场景覆盖: 空响应、长响应截断、非 TextChunk 事件过滤、无文本消息

### dispatch_chat 签名一致性
- `dispatch.py:47-58`: keyword-only args，`identity` 和 `dm_scope` 默认 None
- Telegram 路径 (`telegram.py:141-150`): 显式传入 identity + dm_scope
- WebSocket 路径 (`app.py:280-288`): 不传 identity/dm_scope (使用 AgentLoop 默认值)
- 两条路径签名一致，语义正确

---

## Residual Risks

| Risk | Severity | Mitigation |
|------|----------|------------|
| `check_ready()` 无显式 timeout | LOW | aiogram aiohttp 默认 timeout 兜底；Phase 3+ hardening |
| Telegram long polling 限单 worker | LOW | Plan 已文档化约束；ADR 0044 (Phase 4) 归档 |
| 错误消息英文 | LOW | Phase 3 覆盖中文错误消息映射 |

---

## Gate Recommendation

**RECOMMEND CLOSE m4-g2.**

所有 10 项核心验收标准通过。无 P0/P1 finding。3 个 LOW/INFORMATIONAL findings 均已安排在后续 Phase 处理，不阻塞当前 gate。代码质量符合项目规范，测试覆盖充分。
