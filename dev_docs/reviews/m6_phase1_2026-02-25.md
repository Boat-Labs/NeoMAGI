# M6 Phase 1 Gate Review

- Gate: G-M6-P1
- Commit: `5c99202` (feat/backend-m6-impl)
- Reviewer: tester
- Date: 2026-02-25
- Baseline: `fbae58d` (Phase 0)

## 结论: FAIL

21 个 integration test event loop errors 是 Phase 1 引入的 regression（非 pre-existing），违反"全量测试绿"硬门槛。

## Gate G-M6-P1 验收条件

| 条件 | 结果 | 证据 |
|------|------|------|
| 全量测试绿 | **FAIL** | 519 passed, 21 errors（baseline `fbae58d`: 495 passed, 0 errors） |
| 路由/错误码/预算/幂等与并发语义测试通过 | PASS | test_provider_registry (7), test_gateway_provider (10), test_budget_gate (16), test_eval_run_id (8) — 全部通过 |
| BudgetGate 真实 PG 并发预占测试执行并通过 | PASS | test_concurrent_reserves_no_oversell + test_multi_worker_concurrent_reserves 均通过（real PG via testcontainers） |
| Curator model 参数化测试通过 | PASS | test_curator_model (4) 全部通过 |
| just lint clean | PASS | `ruff check src/` All checks passed |

## Pre-existing Errors Analysis

**结论：21 个 errors 均为 Phase 1 引入的 regression，非 pre-existing。**

| 验证步骤 | 结果 |
|----------|------|
| Baseline `fbae58d` 全量测试 | 495 passed, **0 errors** |
| Phase 1 `5c99202` 全量测试 | 519 passed, **21 errors** |
| 21 个 error tests 单独运行 | **21 passed**（无 error） |
| budget_gate + 21 error tests 一起运行 | 16 passed, **21 errors**（复现） |

### 受影响测试清单

| 文件 | 错误数 | 错误类型 |
|------|--------|---------|
| tests/integration/test_evolution_e2e.py | 9 | RuntimeError: Runner.run() cannot be called from a running event loop |
| tests/integration/test_memory_bm25.py | 6 | 同上 |
| tests/integration/test_session_db.py | 6 | 同上 |

### 根因分析

新增的 `tests/integration/test_budget_gate.py`（16 个 async integration tests）与现有 integration tests 共享 session-scoped `db_engine` fixture。当全量运行时，pytest-asyncio 在 budget_gate tests 和 evolution_e2e/memory_bm25/session_db tests 之间产生 event loop 冲突。

证据：
- `budget_gate` tests 单独运行时有 `RuntimeWarning: coroutine ... was never awaited` 警告
- 仅当 budget_gate tests 与其他 integration tests 同时收集时才触发 errors
- 错误发生在 fixture setup 阶段（`pytest_asyncio/plugin.py:458`），非测试逻辑

## Requirement-Evidence Matrix

| 需求 (ADR/Plan) | 实现位置 | 测试覆盖 | 状态 |
|-----------------|---------|---------|------|
| ADR 0040: agent-run 级 provider 路由 | `src/agent/provider_registry.py` (AgentLoopRegistry) + `src/gateway/app.py` (_handle_chat_send 路由) | test_provider_registry (7), test_gateway_provider (10) | OK |
| ADR 0040: 相邻 chat.send 可用不同 provider | `src/gateway/protocol.py` (ChatSendParams.provider) + `src/gateway/app.py` (registry.get(parsed.provider)) | test_provider_registry::test_multiple_providers, test_gateway_provider::test_provider_explicit_* | OK |
| ADR 0041: 全 provider 统一预算池 | `src/gateway/budget_gate.py` (budget_state 全局行) | test_budget_gate::test_cross_provider_shared_budget | OK |
| ADR 0041: PG 原子预占 | `budget_gate.py:try_reserve` (UPDATE WHERE + row lock) | test_budget_gate::TestTryReserve (10 tests) | OK |
| ADR 0041: 多 worker 安全 | `budget_gate.py` PG row-level lock serialization | test_budget_gate::TestConcurrency (2 tests) | OK |
| ADR 0041: 幂等对账 (settle CAS) | `budget_gate.py:settle` (UPDATE WHERE status='reserved') | test_budget_gate::TestSettle (4 tests) | OK |
| ADR 0041: warn/stop 两阈值 €20/€25 | `budget_gate.py` BUDGET_WARN_EUR=20.0, BUDGET_STOP_EUR=25.0 | test_reserve_over_warn_still_allowed, test_reserve_exceeds_stop | OK |
| Plan: Curator model 参数化 | `src/memory/curator.py` (self._model) + `src/config/settings.py` (curation_model) | test_curator_model (4 tests) | OK |
| Plan: temperature 参数一致 | `src/agent/model_client.py` ABC + impl | test_curator_model::test_temperature_passed_to_model_client | OK |
| Plan: _extract_eval_run_id | `src/gateway/app.py:_extract_eval_run_id` | test_eval_run_id (8 tests) | OK |
| Plan: alembic migration | `alembic/versions/f7a8b9c0d1e2_add_budget_tables.py` | budget_gate integration tests 依赖表结构 | OK |
| Plan: ValidationError→INVALID_PARAMS | `app.py:_handle_chat_send` try/except ValidationError | test_app_integration (existing) | OK |
| Plan: KeyError→PROVIDER_NOT_AVAILABLE | `app.py:_handle_chat_send` try/except KeyError | test_gateway_provider + app routing logic | OK |

## Code Review Findings

### P0 (blocker)

无。

### P1 (should fix before Gate pass)

1. **Event loop regression**: Phase 1 引入 21 个 integration test errors（详见 Pre-existing Errors Analysis）。需修复 `tests/integration/test_budget_gate.py` 与现有 async integration tests 的 event loop 冲突。
   - 推荐修复方向：确保 budget_gate fixture 的 event loop scope 与其他 integration tests 一致，或调整 conftest.py 的 `_integration_cleanup` 对新表的处理方式。

2. **缺少 `@pytest.mark.pg_required` 标记**: Gate 要求 budget gate PG 并发测试需有 `pg_required` marker，当前未实现。虽然测试实际已在 real PG 上运行并通过，但缺少显式标记不符合 Gate 规范。

### P2 (nice to have)

1. **_extract_eval_run_id 未接入**: 函数已定义但未在 `_handle_chat_send` 中调用，budget_gate.try_reserve 也未在请求链路中调用。这是 Phase 2 的接线工作，Phase 1 的代码作为脚手架是合理的。

2. **BudgetGate 未在请求链路中激活**: `app.state.budget_gate` 已创建但 `_handle_chat_send` 未调用 `try_reserve/settle`。同上，Phase 2 工作。

3. **conftest.py 安全性**: `_integration_cleanup` 中的 f-string SQL 拼接 schema 名（`f" WHERE table_schema = '{DB_SCHEMA}'"`）理论上有 SQL injection 风险，但 `DB_SCHEMA` 是常量，实际无风险。后续可改为参数化查询。

## Residual Risks

1. budget_gate PG concurrent tests 使用 `asyncio.gather` 模拟并发，在单 worker 测试环境中实际是 cooperative concurrency（非真正多进程竞争）。真实多 worker 场景的 PG 行锁语义已由 SQL 保证，但集成测试覆盖的并发强度有限。

2. `_extract_eval_run_id` 的 fallback 路径（`len(parts) < 5`）返回完整 session_id 作为 eval_run_id，在异常 session_id 格式下可能导致 eval 分析混乱。建议 Phase 2 接入时加日志。

## Gate 建议

**FAIL** — 需修复以下两项后重新提交 Gate：

1. [P1] 修复 21 个 integration test event loop regression，使 `just test` 恢复全绿（519 passed + 21 currently erroring → 540 passed, 0 errors）
2. [P1] 为 budget gate PG 测试添加 `@pytest.mark.pg_required` 标记

修复后预期结论可升级为 **PASS**。
