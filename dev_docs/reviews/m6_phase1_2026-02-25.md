# M6 Phase 1 Gate Review

- Gate: G-M6-P1
- Commit: `5c99202` (Phase 1 impl) → `91a5c3e` (P1 fixes)
- Reviewer: tester
- Date: 2026-02-25
- Baseline: `fbae58d` (Phase 0)

## 结论: PASS

初审 FAIL（21 event loop regression + 缺少 pg_required marker）。Backend 修复后（`91a5c3e`）重新验收：540 passed, 0 errors, lint clean。所有 Gate 条件满足。

## Gate G-M6-P1 验收条件

| 条件 | 结果 | 证据 |
|------|------|------|
| 全量测试绿 | PASS | 540 passed, 0 errors (fix commit `91a5c3e`) |
| 路由/错误码/预算/幂等与并发语义测试通过 | PASS | test_provider_registry (7), test_gateway_provider (10), test_budget_gate (16), test_eval_run_id (8) — 全部通过 |
| BudgetGate 真实 PG 并发预占测试执行并通过 | PASS | test_concurrent_reserves_no_oversell + test_multi_worker_concurrent_reserves 均通过（real PG via testcontainers, marked `@pytest.mark.pg_required`） |
| Curator model 参数化测试通过 | PASS | test_curator_model (4) 全部通过 |
| just lint clean | PASS | `ruff check src/` All checks passed |

## P1 Fix 验证 (commit `91a5c3e`)

### P1-1: Event loop regression — FIXED

| 验证项 | 结果 |
|--------|------|
| 修复前 `just test` | 519 passed, 21 errors |
| 修复后 `just test` | **540 passed, 0 errors** |
| 修复方式 | `budget_gate` fixture 显式依赖 `db_session_factory`，确保 session-scoped fixture chain 在同一 event loop scope 初始化 |
| 修复评估 | 最小化、根因正确。comment 准确描述问题（lazy setup → event loop scope mismatch → session corruption） |

### P1-2: pg_required marker — FIXED

| 验证项 | 结果 |
|--------|------|
| `@pytest.mark.pg_required` 标记 | 已添加到 `test_concurrent_reserves_no_oversell` + `test_multi_worker_concurrent_reserves` |
| `pyproject.toml` marker 注册 | 已注册 `pg_required` marker 定义 |

## Pre-existing Errors Analysis (初审记录)

初审发现 21 errors 均为 Phase 1 引入的 regression（非 pre-existing）：

| 验证步骤 | 结果 |
|----------|------|
| Baseline `fbae58d` 全量测试 | 495 passed, **0 errors** |
| Phase 1 `5c99202` 全量测试 | 519 passed, **21 errors** |
| Fix `91a5c3e` 全量测试 | **540 passed, 0 errors** |

根因：`budget_gate` fixture 仅依赖 `db_engine` 而未依赖 `db_session_factory`，导致 autouse `_integration_cleanup` fixture 在 budget_gate tests teardown 时延迟初始化 `db_session_factory`，触发 event loop scope 冲突。修复后问题消除。

## Requirement-Evidence Matrix

| 需求 (ADR/Plan) | 实现位置 | 测试覆盖 | 状态 |
|-----------------|---------|---------|------|
| ADR 0040: agent-run 级 provider 路由 | `src/agent/provider_registry.py` (AgentLoopRegistry) + `src/gateway/app.py` (_handle_chat_send 路由) | test_provider_registry (7), test_gateway_provider (10) | OK |
| ADR 0040: 相邻 chat.send 可用不同 provider | `src/gateway/protocol.py` (ChatSendParams.provider) + `src/gateway/app.py` (registry.get(parsed.provider)) | test_provider_registry::test_multiple_providers, test_gateway_provider::test_provider_explicit_* | OK |
| ADR 0041: 全 provider 统一预算池 | `src/gateway/budget_gate.py` (budget_state 全局行) | test_budget_gate::test_cross_provider_shared_budget | OK |
| ADR 0041: PG 原子预占 | `budget_gate.py:try_reserve` (UPDATE WHERE + row lock) | test_budget_gate::TestTryReserve (10 tests) | OK |
| ADR 0041: 多 worker 安全 | `budget_gate.py` PG row-level lock serialization | test_budget_gate::TestConcurrency (2 tests, @pg_required) | OK |
| ADR 0041: 幂等对账 (settle CAS) | `budget_gate.py:settle` (UPDATE WHERE status='reserved') | test_budget_gate::TestSettle (4 tests) | OK |
| ADR 0041: warn/stop 两阈值 €20/€25 | `budget_gate.py` BUDGET_WARN_EUR=20.0, BUDGET_STOP_EUR=25.0 | test_reserve_over_warn_still_allowed, test_reserve_exceeds_stop | OK |
| Plan: Curator model 参数化 | `src/memory/curator.py` (self._model) + `src/config/settings.py` (curation_model) | test_curator_model (4 tests) | OK |
| Plan: temperature 参数一致 | `src/agent/model_client.py` ABC + impl | test_curator_model::test_temperature_passed_to_model_client | OK |
| Plan: _extract_eval_run_id | `src/gateway/app.py:_extract_eval_run_id` | test_eval_run_id (8 tests) | OK |
| Plan: alembic migration | `alembic/versions/f7a8b9c0d1e2_add_budget_tables.py` | budget_gate integration tests 依赖表结构 | OK |
| Plan: ValidationError→INVALID_PARAMS | `app.py:_handle_chat_send` try/except ValidationError | test_app_integration (existing) | OK |
| Plan: KeyError→PROVIDER_NOT_AVAILABLE | `app.py:_handle_chat_send` try/except KeyError | test_gateway_provider + app routing logic | OK |

## Code Review Summary

**生产代码 (8 files)**: 质量良好，无 P0/P1 问题。

- **AgentLoopRegistry**: 设计极简，启动预建 + get() 路由优先级（name > default）+ KeyError 映射，符合 ADR 0040。
- **BudgetGate**: PG `UPDATE WHERE` guard 原子性正确，`Decimal` 处理避免浮点误差，settle CAS 幂等，符合 ADR 0041。
- **app.py**: lifespan registry 构建逻辑清晰，ValidationError→INVALID_PARAMS / KeyError→PROVIDER_NOT_AVAILABLE 错误映射闭环。backward compat `app.state.agent_loop` 保留合理。
- **protocol.py**: provider validator normalize (strip/lower/空串→None) 边界处理完整。
- **model_client.py**: temperature 参数在 ABC 4 个方法 + 实现中一致。
- **curator.py**: `self._model = model or settings.curation_model` 简洁合理。
- **settings.py**: GeminiSettings（api_key="" → disabled）、ProviderSettings（active validator）设计正确。
- **alembic migration**: budget_state 单行 global + budget_reservations 含 eval_run_id/session_id，partial index on status='reserved'。

### P2 (nice to have, 不阻塞 Gate)

1. `_extract_eval_run_id` 和 `budget_gate.try_reserve/settle` 已定义但未在请求链路中调用——Phase 2 接线工作，Phase 1 作为脚手架合理。
2. `_extract_eval_run_id` fallback 路径（`len(parts) < 5`）返回完整 session_id，异常格式下可能影响 eval 分析。建议 Phase 2 接入时加日志。
3. conftest.py `_integration_cleanup` 的 f-string SQL 拼接 schema 名理论上有 injection 风险，但 `DB_SCHEMA` 是常量，实际无风险。

## Residual Risks

1. BudgetGate PG concurrent tests 使用 `asyncio.gather` 模拟并发（cooperative concurrency），非真正多进程竞争。PG 行锁语义由 SQL 保证，但测试覆盖的并发强度有限。
2. Budget gate 阈值 €20/€25 硬编码在代码中，后续若需可配置化需改动。

## Gate 建议

**PASS** — 所有 Gate 条件满足。建议合并 `feat/backend-m6-impl` 至 main。
