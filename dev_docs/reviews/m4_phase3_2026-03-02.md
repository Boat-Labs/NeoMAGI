# M4 Phase 3 Acceptance Report — Response Rendering

> Gate: m4-g3 | Phase: 3 | Target commit: 7d66603
> Reviewer: tester | Date: 2026-03-02
> Plan ref: `dev_docs/plans/m4_telegram-channel-integration_2026-03-02.md` Phase 3

## Conclusion: PASS

All 8 gate acceptance criteria verified. 657 tests green, ruff clean.
No P0/P1 findings.

---

## Requirement-Evidence Matrix

| # | Requirement | Evidence | Status |
|---|------------|----------|--------|
| 1 | split_message() 遵守 max_length | `telegram_render.py:31-73` — 早返回/缓冲区累积/hard cut 三级保障; tests: `test_all_chunks_within_limit`, `test_hard_cut_no_boundaries`, `test_exact_limit_single_chunk`, `test_custom_max_length` | PASS |
| 2 | 段落边界拆分 | `telegram_render.py:130-154` `_split_paragraphs()` — `text.split("\n\n")`; test: `test_splits_on_paragraph_boundary` (3000+3000 chars) | PASS |
| 3 | 代码块保护 | `telegram_render.py:76-87` `_split_preserving_code_blocks()` regex 识别 + `_split_code_block()` 重包围 fences; tests: `test_preserves_small_code_block`, `test_code_block_kept_intact_across_split`, `test_oversized_code_block_splits_with_fences` | PASS |
| 4 | MarkdownV2 转换 | `telegram_render.py:190-206` — `_HAS_MARKDOWN_RE` 检测 + `_to_markdownv2()` 转换 (**bold** → *bold*, 特殊字符转义, 代码块保护); tests: `test_code_block_triggers_markdownv2`, `test_bold_conversion`, `test_bold_with_special_chars`, `test_escapes_special_chars_outside_code` | PASS |
| 5 | MarkdownV2 失败 → 纯文本回退 | 双层回退: (1) `telegram_render.py:205-206` format 层 `except → (text, None)`; (2) `telegram.py:189-192` send 层 `parse_mode=None` 重发; tests: `test_plain_text_no_markdown` | PASS |
| 6 | 错误消息中文映射 | `telegram_render.py:9-16` — SESSION_BUSY/BUDGET_EXCEEDED/PROVIDER_NOT_AVAILABLE + 默认回退; tests: `test_session_busy`, `test_budget_exceeded`, `test_provider_not_available`, `test_unknown_code`, `test_none_code` | PASS |
| 7 | telegram_render 集成到 _handle_dm | `telegram.py:18` import + `:157` `_send_response()` + `:159-173` GatewayError/Exception 分别用 `friendly_error_message()`; adapter tests 更新: `parse_mode=None` 断言 + `test_long_response_split` + 中文错误断言 | PASS |
| 8 | 657 tests green, ruff clean | `just test`: 657 passed in 13.82s; `just lint`: All checks passed | PASS |

---

## Findings

### F1 (LOW) — MarkdownV2 send 回退路径发送转义文本

`telegram.py:189-192`: 当 `format_for_telegram()` 返回 MarkdownV2 格式文本但 Telegram API 拒绝发送时，回退使用 `parse_mode=None` 重发。此时 `part` 仍包含 MarkdownV2 转义字符（如 `10\.5\!`），用户会看到转义符号。

**影响**: 仅在 MarkdownV2 格式化成功但 Telegram 发送失败的极端边界情况下触发。实际发生概率低。

**建议**: 后续 hardening 可考虑在 send 回退时使用原始未转义文本。不阻塞 gate。

### F2 (INFORMATIONAL) — 中文句子拆分

`telegram_render.py:28`: `_SENTENCE_BOUNDARY_RE = re.compile(r"(?<=[.!?。！？])\s+")`

中文句子通常以`。`结尾后不跟空格。当前 regex 要求句号后有 `\s+` 才拆分。但 `test_chinese_sentence_splitting` 通过，因为中文文本超长时最终通过 hard cut 拆分。功能正确，仅拆分点不总在句子边界。

**影响**: 美观性问题，不影响正确性（max_length 保证不变）。

### F3 (INFORMATIONAL) — _send_response 无独立单元测试

`telegram.py:181-194` `_send_response()` 方法通过 adapter 集成测试间接覆盖，但 MarkdownV2 send 失败回退路径（F1 场景）无直接测试。

**影响**: 防御性代码路径未测试，但属于 defense-in-depth。

---

## P3 变更质量评估

### 新增模块 telegram_render.py
- **拆分优先级**: code-block → paragraph → sentence → hard cut，层次清晰
- **代码块保护**: regex 识别 + 超长代码块重包围 fences，实现正确
- **MarkdownV2 转换**: token 化 approach (code/inline-code 保护 + plain 段转义)，符合 Telegram API 要求
- **错误映射**: 3 个已知 code + 默认回退，极简且完备

### telegram.py 集成
- `_handle_dm` 错误处理从单层 `except Exception` 拆分为 `GatewayError` + `Exception` 两层
- `_send_response()` 方法封装 format → split → send 流程，含 MarkdownV2 send 回退
- 移除 P2 的简单截断逻辑，改用 `split_message()` — 更优方案

### 测试覆盖
- 新增 27 个 render 测试（split: 12, format: 10, error: 5）
- adapter 测试更新：3 处 `parse_mode=None` 断言 + `test_long_response_split` 替换 `test_long_response_truncated` + 中文错误断言

---

## Residual Risks

| Risk | Severity | Mitigation |
|------|----------|------------|
| MarkdownV2 send 回退显示转义字符 | LOW | 极端边界场景；后续 hardening |
| 中文句子拆分不总在边界 | LOW | max_length 保证正确性；美观性问题 |
| _send_response 回退路径无独立测试 | LOW | 集成测试间接覆盖 |

---

## Gate Recommendation

**RECOMMEND CLOSE m4-g3.**

8/8 核心验收标准通过。无 P0/P1 finding。3 个 LOW/INFORMATIONAL findings 均不阻塞。telegram_render 模块设计清晰、实现正确、测试充分。与 TelegramAdapter 集成完整。
