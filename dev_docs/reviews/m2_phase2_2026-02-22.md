# Gate 2: Compaction Engine Verification Report

**Milestone**: M2 Session Continuity
**Phase**: Phase 2 — Compaction Core Engine
**Commit**: 48b60d1
**Tester**: tester (worktree: `feat/test-m2-session-continuity`)
**Date**: 2026-02-22
**Gate Result**: **PASS (with observations)**

---

## 1. Test Execution

| Metric | Result |
|--------|--------|
| Total tests | 196 passed, 26 deselected |
| New tests (Phase 2) | 36 (test_compaction: 15, test_memory_flush: 14, test_compaction_smoke: 2, settings validation: 3+2 in existing) |
| Failures | 0 |
| Errors | 0 |
| Lint (`src/`) | PASS (ruff clean) |

**Command**: `uv run pytest tests/ -v`

---

## 2. Gate 2 Checklist Verification

### 2.1 Migration Forward/Reverse Syntax

**Status**: PASS (static review)

- File: `alembic/versions/c4d5e6f7a8b9_add_compaction_fields_to_sessions.py`
- `upgrade()`: 4 `add_column` calls — `compacted_context` (Text), `compaction_metadata` (JSONB), `last_compaction_seq` (Integer), `memory_flush_candidates` (JSONB)
- `downgrade()`: 4 `drop_column` in reverse order (LIFO)
- Schema: `neomagi` (matches `DB_SCHEMA`)
- All columns: `nullable=True` (backward compatible, no data migration required)
- `down_revision`: `b3c4d5e6f7a8` (chains correctly)

**Note**: Cannot execute actual migration without DB connection. Static review only.

### 2.2 Noop Semantics

**Status**: PASS

Verified via 4 test scenarios + code review:

| Scenario | Test | Code Path |
|----------|------|-----------|
| Empty history | `test_noop_when_empty_history` | `compaction.py:151-156` |
| Turns <= min_preserved | `test_noop_when_few_turns` | `compaction.py:169-177` |
| Already compacted | `test_noop_when_already_compacted` | `compaction.py:182-196` |
| Idempotent | `test_noop_idempotent` | Same as already compacted |

All noop cases return `CompactionResult(status="noop")` with no LLM call.
ADR 0031 compliance: noop skips DB write (caller responsibility per `store_compaction_result` docstring line 297).

### 2.3 Anchor Validation Path (ADR 0030)

**Status**: PASS (phrase-level matching, see O1 updated)

Code path (`compaction.py:267-299`):
1. After LLM summary, `_validate_anchors(system_prompt, summary_text, preserved_text)` is called
2. `_extract_anchor_phrases()` 从 AGENTS/SOUL/USER workspace 文件提取首行 probe phrase
3. 验证每个 phrase 在 final context (system_prompt + compacted_context + preserved_text) 中可见
4. On failure + `anchor_retry_enabled=True`: retry once with same parameters
5. On second failure: `status = "degraded"`, `anchor_retry_used = True`

### 2.4 Watermark Monotonic Increase (ADR 0031)

**Status**: PASS

Verified via:
- `test_watermark_monotonic_increase`: `new_compaction_seq > last_compaction_seq`
- `test_watermark_does_not_exceed_current_user_seq`: `new_compaction_seq <= current_user_seq - 1`
- Code: `compaction.py:199-201` — `min(compressible_turns[-1].end_seq, current_user_seq - 1)`
- DB guard: `store_compaction_result` WHERE clause (`last_compaction_seq < result.new_compaction_seq`) prevents regression
- Smoke test: `test_second_compaction_advances_watermark` proves rolling advancement

### 2.5 Flush Candidate Structure (m2_architecture.md 3.3)

**Status**: PASS

All 7 fields verified via `test_candidate_structure_complete`:

| Field | Type | Verified |
|-------|------|----------|
| `candidate_id` | str (uuid4) | non-empty |
| `source_session_id` | str | propagated correctly |
| `source_message_ids` | list[str] | non-empty, contains seq |
| `candidate_text` | str | non-empty, truncated to `max_candidate_text_bytes` |
| `constraint_tags` | list[str] | valid tags: `user_preference`, `safety_boundary`, `fact` |
| `confidence` | float | clamped to [0.0, 1.0] via `min(max(...))` |
| `created_at` | str | ISO 8601 format |

Additional coverage:
- `test_max_candidates_limit`: respects `max_flush_candidates`
- `test_max_text_bytes_truncation`: truncates to byte limit
- `test_session_id_propagated`: session_id flows through
- `test_only_user_messages_extracted`: assistant messages excluded

### 2.6 Confidence Range [0, 1]

**Status**: PASS

- Code: `memory_flush.py:123` — `confidence=min(max(confidence, 0.0), 1.0)`
- Tests: `test_confidence_in_range` verifies across multiple turn types
- Classification bands:
  - Explicit preference: 0.9 (tested ≥ 0.8)
  - Decision/fact: 0.6 (tested 0.5-0.7)
  - General conversation: 0.3 (tested 0.2-0.4)
  - Casual/skip: 0.0 (skipped, not emitted)

### 2.7 Rolling Summary Token Ratio

**Status**: PASS (code review, mock limitation)

- Code: `compaction.py:226` — `max_summary_tokens = int(input_tokens * 0.3)` (strict 30% cap, no floor)
- Input < 100 tokens (30% < 100) 时走 degraded path，跳过 LLM 调用 (`compaction.py:229-247`)
- Summary prompt includes `{max_output_tokens}` instruction to LLM
- Actual enforcement depends on LLM compliance (cannot verify with mock)
- ADR 0028 alignment: same model, structured JSON output, temperature wired from settings (`compaction.py:343`)

### 2.8 schema_version = 1

**Status**: PASS

- Code: `compaction.py:351` — `"schema_version": 1` in `_make_metadata()`
- Tests: `test_metadata_fields_complete` asserts `meta["schema_version"] == 1`
- Smoke: `test_full_pipeline_30_turns` asserts same

### 2.9 ADR Semantic Consistency Audit

**Status**: PASS

| ADR | Requirement | Implementation | Verdict |
|-----|-------------|---------------|---------|
| **0028** (Rolling Summary) | Same model, structured JSON, low temp | `_generate_summary` uses caller-provided model; prompt outputs JSON with 5 keys; `summary_temperature` configurable (default 0.1) | PASS |
| **0030** (Anti-drift) | Anchor validation on final context, retry once, degrade on failure | `_validate_anchors` called after LLM, retry path exists, degrades on double failure | PASS (minimal impl, O1) |
| **0031** (Watermark) | Unique rebuild cutpoint, `seq > last_compaction_seq`, monotonic, noop skips write | `get_effective_history` uses `>` filter; `store_compaction_result` enforces monotonic via SQL WHERE; noop returns early | PASS |
| **0032** (Flush Ownership) | CompactionEngine exclusively generates flush; AgentLoop orchestrates only | `MemoryFlushGenerator` called inside `CompactionEngine.compact()`; module docstrings enforce boundary | PASS |

---

## 3. Observations (Non-blocking)

### O1: Anchor Validation — Updated to Phrase-Level Matching

~~`_validate_anchors` only checks `len(system_prompt) > 50`.~~ **已修复 (post-review F3/F6 周期)**。

当前实现 (`compaction.py:371-397`):
- `_extract_anchor_phrases()` 从 AGENTS.md/SOUL.md/USER.md 提取首个非空行作为 probe phrase
- `_validate_anchors(system_prompt, compacted_context, effective_history_text)` 验证每个 phrase 在最终 model context 中可见
- 校验失败触发 retry → degrade 降级路径（ADR 0030 对齐）

**Risk**: Resolved.

### O2: Type Hint — `store_compaction_result(result: Any)`

`manager.py:291` uses `result: Any` instead of `CompactionResult`. This weakens static type safety.

**Risk**: Low. Runtime behavior is correct; the only caller will pass `CompactionResult`. Recommend adding explicit type import in Phase 3 integration.

### O3: Redundant Exception Catch

`compaction.py:216` and `:239` use `except (TimeoutError, Exception)`. Since `Exception` is a superclass of `TimeoutError`, the `TimeoutError` clause is redundant. Same pattern observed in Phase 1.

**Risk**: None. Functionally correct, cosmetic only.

### O4: Synchronous History Methods

`get_history_with_seq()` and `get_effective_history()` (manager.py:231-260) are synchronous, using in-memory cache only. The plan suggested async, but sync is valid for in-memory operations and avoids unnecessary overhead.

**Risk**: None. Correct for current architecture.

### O5: Flush Timeout Test — Blocking Sleep in Executor

`test_flush_skipped_on_timeout` (test_compaction.py:367-400) patches `flush_generator.generate` with a `time.sleep(0.1)` in the main thread. Since the actual flush runs via `run_in_executor`, the blocking sleep correctly simulates executor delay. Test is valid.

---

## 4. New Module Summary

| Module | LOC | Tests | Purpose |
|--------|-----|-------|---------|
| `src/agent/compaction.py` | 364 | 15 + 2 smoke | Turn splitting, rolling summary, anchor validation, flush integration |
| `src/agent/memory_flush.py` | 153 | 14 | Rule-based memory candidate extraction |
| `alembic/...compaction_fields.py` | 51 | — | Migration: 4 nullable columns on sessions |
| `src/session/manager.py` (delta) | +120 | — | `MessageWithSeq`, `CompactionState`, 4 new methods |
| `src/session/models.py` (delta) | +8 | — | 4 new mapped columns |
| `src/config/settings.py` (delta) | +15 | 5 | Phase 2 CompactionSettings fields |

---

## 5. Residual Risks

| Risk | Severity | Mitigation |
|------|----------|------------|
| Migration not DB-tested | Low | Static review passes; real execution deferred to integration env |
| Anchor validation minimal | Low | Phase 3 should strengthen per ADR 0030 |
| ~~`summary_temperature` not wired to LLM call~~ | ~~Medium~~ Resolved | **已修复 (post-review F3)**。`_generate_summary` 现已将 `self._settings.summary_temperature` 传入 `model_client.chat(temperature=...)` (`compaction.py:343`)。 |
| Rolling summary 30% cap depends on LLM compliance | Low | Prompt instructs limit; actual output length unchecked |

---

## 6. Gate Recommendation

**PASS** — Phase 2 deliverables meet all Gate 2 acceptance criteria. 196 tests pass, lint clean, all ADR semantics verified. Observations are non-blocking and suitable for Phase 3 integration.

Phase 3 (Agent Loop integration) may proceed.
