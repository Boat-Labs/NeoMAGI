# M7 Phase 5 Review

- Milestone: `M7`
- Phase: `5`
- Gate: `G-M7-P5`
- Target commit: `cd6e40f`
- Reviewer role: `tester`
- Review date: `2026-03-01`
- Result: `PASS_WITH_RISK`

## Scope

本轮在 fresh worktree + committed 主线代码上，验证 devcoord teammate 写路径的三类幂等护栏是否在 live `.beads` 上真实生效：

- duplicate pending `GATE_OPEN` 下的 `ACK`
- 相同 `gate + commit` 的 `PHASE_COMPLETE`
- 相同 `gate + commit + last_seen_gate` 的 `RECOVERY_CHECK`

## Evidence

- Committed patch under test:
  - `0419158` `feat(tools): dedupe repeated devcoord teammate writes`
  - `cd6e40f` `test(tools): cover idempotent devcoord teammate writes`
- Fresh clean worktrees:
  - `codex/backend-m7-idempotence-clean`
  - `codex/tester-m7-idempotence-clean`
- Live event sequence in `dev_docs/logs/m7_2026-03-01/heartbeat_events.jsonl`:
  - `event_seq=56` `GATE_OPEN_SENT` backend
  - `event_seq=57` `ACK`
  - `event_seq=58` `GATE_EFFECTIVE`
  - `event_seq=59` duplicate backend `GATE_OPEN_SENT`
  - no second `ACK` or `GATE_EFFECTIVE` after repeated backend `ack`
  - `event_seq=60` `PHASE_COMPLETE`
  - no second `PHASE_COMPLETE` after repeated backend replay
  - `event_seq=61` `GATE_OPEN_SENT` tester
  - `event_seq=62` `RECOVERY_CHECK`
  - no second `RECOVERY_CHECK` after repeated tester replay
- Live audit remained reconciled after duplicate replays:
  - `received_events=62`
  - `logged_events=62`
  - `reconciled=true`

## Findings

- `ACK` 的 live 幂等护栏生效：重复语义的 pending `GATE_OPEN` 被吸收，没有追加第二条 `ACK` / `GATE_EFFECTIVE`。
- `PHASE_COMPLETE` 的 live 幂等护栏生效：相同 `gate + commit` 的重复提交不再落新事件。
- `RECOVERY_CHECK` 的 live 幂等护栏生效：相同 `gate + commit + last_seen_gate` 的重复恢复握手不再落新事件。
- 仍存在一项非阻塞残余风险：若 spawn/prompt 约束不够强，Claude Code CLI 可能偏向错误的 worktree-local 脚本路径；这属于运行控制风险，不构成对本次 clean drill 结论的反证。

## Conclusion

`G-M7-P5` 已证明 committed 幂等补丁在 live `.beads` 路径下可用，可按 `PASS_WITH_RISK` 关闭。残余风险保留在 teammate spawn 与 CLI command shape hardening 中继续处理。
