# M3 Phase 1 Gate Review: G-M3-P1

- **Gate ID**: G-M3-P1
- **验收对象 commit**: `cc24a04`
- **分支**: `feat/backend-m3-impl`
- **验收者**: Tester
- **日期**: 2026-02-24

---

## 1. 放行条件逐项结论

### 条件 1: memory_append 工具正常写入 daily notes + scope_key 元数据正确

**PASS**

- `MemoryAppendTool` 写入 `memory/YYYY-MM-DD.md`，格式为 `---\n[HH:MM] (source: user, scope: {scope_key})\n{text}\n`。
- `scope_key` 从 `context.scope_key` 读取（session_resolver 注入），无 context 时默认 `main`。
- `risk_level = RiskLevel.high`（写操作，正确）。
- 空文本 / 纯空白文本被拒绝（`INVALID_ARGS`）。
- 文件大小超限时抛 `MemoryWriteError`。
- CJK 文本写入正确（UTF-8）。
- 证据：`TestMemoryAppendToolExecute`（5 tests）、`TestAppendDailyNote`（7 tests）全部通过。

### 条件 2: flush 候选自动落盘

**PASS**

- `_try_compact` 在 compaction 完成后检查 `result.memory_flush_candidates` 和 `self._memory_writer`，有候选时调用 `_persist_flush_candidates`。
- `_persist_flush_candidates` 将 agent 层 `MemoryFlushCandidate` 映射为 memory 层 `ResolvedFlushCandidate`（边界隔离正确，无反向依赖）。
- scope_key 从 `candidate.source_session_id` 解析（非当前 session_id），符合 ADR 0034。
- 低 confidence 候选被过滤（`min_confidence=0.5`）。
- 失败整体 try/except 包裹，`logger.exception` 记录但不阻断主流程。
- 无候选时跳过，不创建文件。
- 证据：`TestPersistFlushCandidates`（6 tests）、`TestProcessFlushCandidates`（5 tests）全部通过。

### 条件 3: daily notes 自动加载（今天+昨天）

**PASS**

- `PromptBuilder._load_daily_notes` 加载 `daily_notes_load_days`（默认 2）天的文件。
- 结果注入 `_layer_workspace` 中，以 `[Recent Daily Notes]\n=== YYYY-MM-DD ===` 格式呈现。
- `MemorySettings.daily_notes_max_tokens` 控制截断（默认 4000 tokens，~16000 chars）。
- scope 过滤通过 `_filter_entries_by_scope` 实现，按 `---` 分割 entry 后正则匹配 `scope:\s*(\S+)`。
- 证据：`TestLoadDailyNotes`（7 tests）、`TestDailyNotesInBuild`（1 test）全部通过。

### 条件 4: 旧数据兼容

**PASS**

- 无 scope 元数据的 entry（pre-M3 数据）视为 `scope_key='main'`。
- `scope_key='main'` 请求时包含旧数据；非 main 请求时排除旧数据。
- 证据：`test_old_data_compatibility`、`test_old_data_excluded_for_non_main`、`test_no_scope_metadata_as_main` 全部通过。

### 条件 5: 全量回归

**PASS**

- `just test`：**362 passed, 0 failed** ✓（较 Phase 0 增加 46 个测试）
- `just lint`：**All checks passed** ✓

---

## 2. Code Review 发现

### 2.1 架构

- **模块边界正确**：`memory/contracts.py` 零依赖 agent 层；`memory/writer.py` 仅依赖 `contracts` 和 `infra/errors`；`AgentLoop` 在边界执行 `MemoryFlushCandidate → ResolvedFlushCandidate` 映射。符合 plan rev6 的反向依赖消除设计。
- **MemorySettings 归属正确**：独立 `BaseSettings` 子类，`MEMORY_` 前缀，通过 `Settings.memory` 组合。
- **PromptBuilder 扩展干净**：`memory_settings` 作为可选参数注入，daily notes 加载在 `_layer_workspace` 中自然融合。

### 2.2 正确性

- **scope 传播链完整**：`session_resolver → ToolContext.scope_key → MemoryAppendTool` 和 `candidate.source_session_id → resolve_scope_key → ResolvedFlushCandidate.scope_key → MemoryWriter`，两条路径均正确。
- **entry 格式解析稳健**：`_filter_entries_by_scope` 使用 `rstrip(")")` 处理 `(scope: main)` 格式中的括号，旧数据无 scope 时 fallback 到 main。
- **截断策略合理**：`max_tokens * 4` 粗估字符数，截断后追加 `...(truncated)` 标记。

### 2.3 编码规范

- **同步文件 I/O**（non-blocking observation）：`writer.py:append_daily_note` 使用 `filepath.open("a")` 和 `filepath.stat()` 同步操作，`prompt_builder.py:_load_daily_notes` 使用 `filepath.read_text()` 同步读取。CLAUDE.md 规定"文件读写（aiofiles）"应为 async。当前 daily notes 文件极小（≤32KB），性能影响可忽略，但不符合编码规范。建议后续统一迁移到 aiofiles。**不影响放行**。

### 2.4 安全

- `MemoryAppendTool` 声明 `risk_level=high`（写操作），受 guardrail 保护。在无 contract 文件的环境中会被阻断，符合 fail-closed 设计。
- `MemoryWriter` 不接受绝对路径，写入范围限定在 `workspace/memory/` 下。
- flush 候选持久化的异常被 catch，不会泄露到用户侧。

### 2.5 边缘情况

- `_persist_flush_candidates` 不检查 `self._memory_writer is None`，依赖调用方 `_try_compact` 的 `if self._memory_writer` 守卫。方法自身的 `except Exception` 作为安全网。可接受但建议后续加显式 guard。
- `_filter_entries_by_scope` 的 `\S+` 匹配会捕获连字符等特殊字符（如 `scope: per-peer`），`rstrip(")")` 只移除尾部括号。M4 扩展时需验证复杂 scope 格式的兼容性。

---

## 3. 总结论

### **PASS**

5/5 放行条件全部通过。Phase 1 Memory Write Path 实现正确、测试充分、架构清晰。

### 遗留建议（non-blocking）

1. `writer.py` 和 `prompt_builder.py` 中的同步文件 I/O 建议后续迁移到 aiofiles。
2. `_persist_flush_candidates` 建议添加 `if not self._memory_writer: return` 显式 guard。
3. M4 扩展时验证 `_filter_entries_by_scope` 对复杂 scope 格式的兼容性。
